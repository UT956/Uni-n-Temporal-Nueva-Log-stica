<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NUEVA LOGISTICA UT - Optimizado y Responsivo (con video)</title>
<link rel="icon" href="img/1.jpeg" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --blue-700:#1976d2; --blue-500:#4f83ff; --bg:#f6fbff; --card:#fff; --muted:#5b7b93; --danger:#ef5350;
    --ui-padding:16px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:Inter, "Segoe UI", system-ui, Arial; background:linear-gradient(135deg,#e9f2ff 0%,var(--bg) 100%);min-height:100vh;padding:var(--ui-padding);color:#072033; -webkit-font-smoothing:antialiased;}
  .container{max-width:1200px;margin:0 auto}

  /* Card */
  .card{background:var(--card);border-radius:12px;box-shadow:0 10px 30px rgba(10,30,60,0.06);padding:14px;margin-bottom:14px}
  h1{font-size:1.45rem;color:var(--blue-700);margin-bottom:6px}
  p.lead{Color:var(--muted);font-size:.95rem;margin-bottom:8px}

  /* Buttons */
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800;color:#fff}
  .btn.primary{background:linear-gradient(135deg,var(--blue-500),var(--blue-700))}
  .btn.info{background:linear-gradient(135deg,#29b6f6,#0288d1)}
  .btn.success{background:linear-gradient(135deg,#00e676,#00c853);color:#022}
  .btn.muted{background:#f1f5f9;color:#072033}
  .btn.danger{background:linear-gradient(135deg,#ff6b6b,#ee5252);color:#fff}

  /* FABs (ajustado para no verse angosto) */
  .fab{min-width:48px;height:48px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(10,30,60,0.12);border:none;cursor:pointer;font-size:18px;color:#fff;padding:6px}
  .fab.camera{background:linear-gradient(135deg,#ffb74d,#ff8a65)}
  .fab.view{background:linear-gradient(135deg,var(--blue-500),var(--blue-700))}
  .fab.edit{background:linear-gradient(135deg,#7e57c2,#5e35b1)}
  .fab.delete{background:linear-gradient(135deg,#ff5252,#e53935)}
  .fab.video{background: linear-gradient(135deg, #ff8a65, #ff3d00); }

  .fab:active{transform:scale(.96)}

  .ripple{position:relative;overflow:hidden}
  .ripple::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle, rgba(255,255,255,0.18) 10%, transparent 10.01%);opacity:0;transform:scale(10);transition:opacity .6s,transform .6s}
  .ripple:active::after{opacity:1;transform:scale(0);transition:0s}

  /* Top header */
  .topbar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .pills{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(6,30,49,0.04);padding:8px 12px;border-radius:999px;font-weight:700;color:#083044}

  /* Forms / Controls */
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:12px}
  label{font-weight:700;font-size:.9rem;color:#123}
  input[type=text],input[type=number],input[type=date],input[type=password]{width:100%;padding:9px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff}

  /* Login centered */
  #loginCard { max-width:720px; margin: 18px auto; display:flex;flex-direction:column; gap:12px; align-items:stretch; }
  #loginCard .inputs { display:flex; gap:8px; flex-wrap:wrap; }
  #loginCard input { min-width: 140px; }

  /* Virtualized table - responsive (adjustable) */
  .table-wrapper { overflow:hidden }
  .table-viewport{height:420px;overflow:auto;border-radius:10px;background:var(--card);border:1px solid #eef6ff}
  .table-inner{position:relative;height:0}

  .row{position:absolute;left:0;right:0;display:flex;align-items:center;padding:10px;border-bottom:1px solid #f1f6fa;gap:10px;font-size:.92rem;height:68px}
  .col-checkbox{flex:0 0 42px;max-width:42px}
  .col-item{flex:0 0 13%; min-width:90px; max-width:220px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-dim{flex:0 0 12%; min-width:80px; max-width:180px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-acta{flex:0 0 10%; min-width:70px; max-width:140px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-fecha{flex:0 0 10%; min-width:80px; max-width:120px}
  .col-desc{flex:1 1 20%; min-width:120px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-cantidad{flex:0 0 8%; min-width:60px; text-align:right}
  .col-ubic{flex:0 0 10%; min-width:90px}
  .col-photo{flex:0 0 9%; min-width:70px; display:flex;align-items:center;justify-content:center}
  .col-ingreso{flex:0 0 12%; min-width:90px}
  .col-actions{flex:0 0 28%; min-width:180px; display:flex;gap:8px;align-items:center;justify-content:flex-end}

  .photo-placeholder{width:72px;height:48px;border-radius:6px;background:#f3f7fb;display:flex;align-items:center;justify-content:center;color:#7793a3;font-weight:800}

  /* Modal & overlay */
  .overlay{position:fixed;inset:0;background:rgba(2,8,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;border-radius:12px;padding:16px;max-width:95%;width:760px;box-shadow:0 20px 50px rgba(0,0,0,0.15)}
  .modal img{max-width:100%;height:auto;border-radius:8px;display:block;margin:0 auto}

  /* compact loader */
  #smallLoader {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background: rgba(8,16,30,0.55);
    color:#fff;
    padding:14px 18px;
    border-radius:12px;
    display:flex;
    align-items:center;
    gap:12px;
    z-index:100000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }
  .small-spinner{width:40px;height:40px;border-radius:50%;border:5px solid rgba(255,255,255,0.14);border-top-color:var(--blue-700);animation:spin .9s linear infinite}
  @keyframes spin { to { transform: rotate(360deg); } }

  .btn .btn-spinner {
    width:16px; height:16px; border-radius:50%;
    border:3px solid rgba(255,255,255,0.28); border-top-color:#fff; animation:spin .8s linear infinite; display:inline-block; vertical-align:middle;
  }

  #barraGuardado { position:fixed; top:0; left:0; width:0%; height:4px; background:linear-gradient(90deg,#00e676,#00c853); z-index:999999; transition:width 1.8s ease; opacity:1; }

  .hidden{display:none !important}
  .toast{position:fixed;right:18px;top:18px;background:var(--blue-700);color:#fff;padding:10px 14px;border-radius:10px;z-index:99999;font-weight:800}

  /* Animaci√≥n del bot√≥n "Eliminar perfil" */
  @keyframes pulseMove {
    0%, 100% { transform: translateY(0) scale(1); box-shadow: 0 0 0 rgba(239,83,80,0.2); }
    50% { transform: translateY(-4px) scale(1.04); box-shadow: 0 12px 28px rgba(239,83,80,0.18); }
  }
  .pulseMove {
    animation: pulseMove 1.6s ease-in-out infinite;
    transition: transform .2s ease;
  }

  @media (max-width:900px){
    .col-item {flex: 0 0 20%}
    .col-dim {flex: 0 0 18%}
    .col-desc {flex: 1 1 25%}
    .col-actions {flex: 0 0 28%}
    .fab{width:44px;height:44px;font-size:16px}
    #loginCard { padding:12px }
  }
  @media (max-width:600px){
    body{padding:10px}
    .controls{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    .col-item{flex: 0 0 24%}
    .col-dim{flex:0 0 22%}
    .col-desc{flex:1 1 28%}
    .col-actions{flex:0 0 32%}
    .col-photo .photo-placeholder{width:56px;height:38px}
    .table-viewport{height:320px}
    .card{padding:12px}
    .btn{padding:8px 10px;font-size:.95rem}
  }
</style>
</head>
<body>
<div id="barraGuardado" aria-hidden="true"></div>

<div id="smallLoader" aria-live="polite" style="display:flex">
  <div class="small-spinner" aria-hidden="true"></div>
  <div style="font-weight:800">Iniciando sistema UT...</div>
</div>

<div class="container" id="app" style="opacity:1;transition:opacity .25s ease">
  <div class="card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <img src="img/1.jpeg" style="width:60px;border-radius:8px" alt="logo">
    <div style="min-width:160px">
      <h1>Uni√≥n Temporal - Nueva Log√≠stica</h1>
      <p class="lead"></p>
    </div>
    <div style="margin-left:auto" class="pills">
      <div id="filePill" class="pill">Archivo vigilado: ninguno</div>
      <div id="syncPill" class="pill">Sincronizaci√≥n: inactiva</div>
    </div>
  </div>

  <div id="loginCard" class="card" role="region" aria-label="Login">
    <h1 style="text-align:center">Iniciar sesi√≥n</h1>
    <p class="lead" style="text-align:center">Introduce tu usuario y contrase√±a</p>

    <div class="inputs" style="display:flex;gap:8px;justify-content:center">
      <input id="loginUsuario" type="text" placeholder="Usuario" style="flex:1;min-width:160px;max-width:360px">
      <input id="loginPassword" type="password" placeholder="Contrase√±a" style="flex:1;min-width:160px;max-width:360px">
      <button class="btn primary" onclick="iniciarSesion()">Ingresar</button>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="btn info" onclick="mostrarRegistroModal()">Registrar</button>
      <button class="btn muted" onclick="mostrarInfo()">¬øC√≥mo funciona?</button>
    </div>
    <div id="loginError" style="color:#d63333;margin-top:10px;text-align:center"></div>
  </div>

  <div id="main" class="card hidden" role="main" aria-live="polite">
    <div class="topbar">
      <div>
        <h1 id="panelTitle" style="margin:0">Panel UT</h1>
        <p class="lead" style="margin:0">Control de inventario y sincronizaci√≥n local con Excel</p>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="currentUserName" style="font-weight:900;color:#072033"></div>
        <button id="btnCambiarPass" class="btn muted" onclick="abrirCambiarClave()">üîê Cambiar Clave</button>
        <!-- Bot√≥n de eliminar del panel principal eliminado a petici√≥n -->
        <button id="btnAdminPanel" class="btn primary hidden" onclick="abrirModalAdmin()">üë• Gestionar Usuarios</button>
        <button class="btn muted" onclick="cerrarSesion()">Salir</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <button id="watchBtn" class="btn info" onclick="toggleWatch()">üîé Vigilar archivo Excel</button>
      <button id="stopWatchBtn" class="btn danger hidden" onclick="stopWatching()">Detener vigilancia</button>
      <button class="btn primary" onclick="document.getElementById('excelFile').click()">üì§ Importar Excel</button>
      <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" onchange="handleImportEvent(event)">
      <button class="btn success" onclick="exportarExcel()">üìÑ Exportar Excel</button>
      <button class="btn muted" onclick="forzarImportDesdeHandle()">Forzar import (vig.)</button>
      <button class="btn muted" onclick="exportarBackupDB()">üì• Exportar backup (JSON)</button>
      <button class="btn muted" onclick="document.getElementById('backupFile').click()">üì§ Importar backup (JSON)</button>
      <input type="file" id="backupFile" accept=".json" style="display:none" onchange="importarBackupDB(event)">
    </div>

    <div class="controls">
      <div>
        <label># Item</label>
        <input id="item" type="text" placeholder="ITEM-001">
      </div>
      <div>
        <label>N√∫mero DIM</label>
        <input id="numeroDim" type="text" placeholder="DIM-001">
      </div>
      <div>
        <label>Acta</label>
        <input id="acta" type="text" placeholder="ACT-2025-001">
      </div>
      <div>
        <label>Fecha</label>
        <input id="fechaSeleccionadaInput" type="date">
      </div>
      <div>
        <label>Descripci√≥n</label>
        <input id="descripcion" type="text" placeholder="Descripci√≥n">
      </div>
      <div>
        <label>Cantidad</label>
        <input id="cantidad" type="number" min="0" value="0">
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;margin-bottom:10px">
      <button class="btn primary ripple" onclick="ingresarDim()">‚ûï Ingresar</button>
      <button class="btn danger" onclick="eliminarSeleccionados()">üóë Eliminar seleccionados</button>
      <button class="btn muted" onclick="renderVisibleRows()">Refrescar vista</button>
      
      <button id="btnGuardar" class="btn success ripple" onclick="guardarTodoManual()">
        <span class="btn-text">üíæ Guardar</span>
      </button>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <button class="btn info ripple" onclick="consultarPorDim()">üîç Consultar N¬∞ DIM</button>
      <button class="btn info ripple" onclick="consultarPorActa()">üîç Consultar N¬∞ Acta</button>
      <button class="btn info ripple" onclick="consultarPorUbicacion()">üìç Consultar Ubicaci√≥n</button>
      <button class="btn info ripple" onclick="consultarPorAnio()">üóìÔ∏è Consultar por A√±o</button>
    </div>
    
    <div id="volverContainer" class="card hidden" style="padding:10px;margin-bottom:12px">
        <p class="lead" style="margin-bottom:6px">Consulta activa</p>
        <button class="btn info ripple" onclick="volverATodosLosRegistros()">
            ‚¨ÖÔ∏è Volver a Todos
        </button>
    </div>
    <div id="progressCard" class="card hidden" style="display:flex;align-items:center;gap:12px">
      <div class="centered"><div class="small-spinner" aria-hidden="true" style="width:36px;height:36px;border-width:4px"></div></div>
      <div style="flex:1">
        <div style="font-weight:800;color:#123">Procesando importaci√≥n...</div>
        <div class="progress-bar" aria-hidden="true" style="margin-top:8px"><div id="progressFill" class="fill" style="width:0%;height:8px;background:linear-gradient(90deg,var(--blue-500),var(--blue-700));border-radius:999px"></div></div>
      </div>
      <div style="margin-left:auto"><button class="btn muted" onclick="cancelImport()">Cancelar</button></div>
    </div>

    <div class="card table-wrapper">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:900">Registros</div>
        <div style="color:var(--muted)">Total: <span id="totalCount">0</span></div>
      </div>

      <div id="tableHeader" style="display:flex;gap:10px;padding:8px;border-bottom:1px solid #eef6ff;font-weight:800;color:#234;align-items:center">
        <div class="col-checkbox"><input id="selectAll" type="checkbox"></div>
        <div class="col-item"># Item</div>
        <div class="col-dim">N√∫mero DIM</div>
        <div class="col-acta">Acta</div>
        <div class="col-fecha">Fecha Egreso</div>
        <div class="col-desc">Descripci√≥n</div>
        <div class="col-cantidad">Cant.</div>
        <div class="col-ubic">Ubicaci√≥n</div>
        <div class="col-photo">Foto</div>
        <div class="col-ingreso">Fecha Ingreso</div>
        <div class="col-actions">Acciones</div>
      </div>

      <div id="viewport" class="table-viewport" onscroll="onScrollViewport()">
        <div id="inner" class="table-inner"></div>
      </div>
    </div>
  </div>
</div>

<div id="modalViewPhoto" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Vista de foto</h3>
    <div id="viewPhotoContainer" style="text-align:center">
      <img id="viewPhotoImg" src="" alt="Foto registro">
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button class="btn muted" onclick="cerrarModal('modalViewPhoto')">Cerrar</button>
    </div>
  </div>
</div>

<div id="modalRegistro" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Registrar Usuario</h3>
    <label>Nombre completo</label><input id="regNombre" type="text">
    <label style="margin-top:8px">Usuario (ID)</label><input id="regUsuario" type="text">
    <label style="margin-top:8px">Contrase√±a</label><input id="regPassword" type="password">
    <label style="margin-top:8px">Confirmar contrase√±a</label><input id="regPasswordConfirm" type="password">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn primary" onclick="registrarUsuarioModal()">Registrar</button>
      <button class="btn muted" onclick="cerrarRegistroModal()">Cancelar</button>
    </div>
    <div id="regError" style="color:#d63333;margin-top:8px"></div>

    <!-- Bot√≥n eliminado de perfil dentro del modal de registro -->
    <div style="text-align:center;margin-top:16px">
      <button class="btn danger pulseMove" onclick="confirmarEliminacionPerfil()">üóëÔ∏è Eliminar perfil de la plataforma</button>
    </div>
  </div>
</div>

<div id="modalCambiar" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Cambiar contrase√±a</h3>
    <label>Contrase√±a actual</label><input id="curPass" type="password">
    <label style="margin-top:8px">Nueva contrase√±a</label><input id="newPass" type="password">
    <label style="margin-top:8px">Confirmar nueva</label><input id="confirmNewPass" type="password">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn primary" onclick="cambiarClave()">Guardar</button>
      <button class="btn muted" onclick="cerrarCambiarClave()">Cancelar</button>
    </div>
    <div id="changePassMsg" style="margin-top:8px"></div>
  </div>
</div>

<div id="modalAdmin" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:760px">
    <h3>üë• Administrar Usuarios</h3>
    <div id="adminList" style="margin-top:10px;max-height:420px;overflow:auto"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn muted" onclick="cerrarModal('modalAdmin')">Cerrar</button>
    </div>
    <div id="adminMsg" style="margin-top:8px"></div>
  </div>
</div>

<input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none">
<input id="videoInput" type="file" accept="video/*" style="display:none">

<script>
/* ========= Sistema completo NUEVA LOGISTICA UT - CORREGIDO + VIDEO ========= */

/* -------- Global state -------- */
let usuarioActual = null;
let datos = [];
let datosVisibles = [];
let contadorUb = { estanteria:1,piso:1,seccion:1,posicion:1 };

/* -------- Virtualization params -------- */
const ROW_HEIGHT = 68;
const BUFFER_ROWS = 8;
const viewport = document.getElementById('viewport');
const inner = document.getElementById('inner');

/* -------- File/watch state -------- */
let excelFileHandle = null;
let watchInterval = null;
const WATCH_INTERVAL_MS = 10000;
let importAbort = { aborted:false };

/* -------- Save debounce -------- */
let saveTimer = null;
function saveDBDebounced(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> {
    if(!usuarioActual) return;
    persistUserData();
  }, 600);
}

/* -------- Utils: dates -------- */
function pad(n){ return String(n).padStart(2,'0'); }
function excelSerialToDate(serial){ 
  if(serial instanceof Date) return serial; 
  const n=Number(serial); 
  if(isNaN(n)) return null; 
  const ms=(n-25569)*86400*1000; 
  const d=new Date(ms); 
  return new Date(d.getFullYear(), d.getMonth(), d.getDate()); 
}

function formatDDMMYYYYAny(value){
  if(!value) return '';
  if(value instanceof Date) return pad(value.getDate())+'/'+pad(value.getMonth()+1)+'/'+value.getFullYear();
  if(!isNaN(Number(value))){
    const maybe = excelSerialToDate(Number(value));
    if(maybe) return pad(maybe.getDate())+'/'+pad(maybe.getMonth()+1)+'/'+maybe.getFullYear();
  }
  const dt = new Date(String(value));
  if(!isNaN(dt)) return pad(dt.getDate())+'/'+pad(dt.getMonth()+1)+'/'+dt.getFullYear();
  return String(value);
}

/* -------- UI helpers -------- */
function mostrarToast(msg, t=2000){ 
  const el=document.createElement('div'); 
  el.className='toast'; 
  el.textContent=msg; 
  document.body.appendChild(el); 
  setTimeout(()=>el.remove(), t); 
}

function mostrarInfo(){ 
  alert('Este sistema sincroniza localmente con Excel y permite fotos y videos por registro (guardados localmente). Usa Chrome/Edge/Safari m√≥vil para mejor experiencia.'); 
}

function cerrarModal(id){ 
  const el = document.getElementById(id);
  if(el) el.classList.add('hidden'); 
}

/* -------- Init app -------- */
window.addEventListener('load', ()=> {
  ensureAdmin();
  setTimeout(()=> {
    const sl = document.getElementById('smallLoader');
    if(sl) sl.style.display = 'none';
  }, 700);
});

/* -------- Auth / Users -------- */
async function ensureAdmin(){ 
  if(window.DBX && DBX.init) {
    try { await DBX.init(); } catch(e){ console.warn('IndexedDB init error', e); }
  }
  const adminExists = window.DBX ? await DBX.getUser('admin') : null;
  if(!adminExists) {
    const tmp = { 
      usuario:'admin', 
      nombre:'Administrador', 
      password:'admin', 
      datos:[], 
      contadorUb:{estanteria:1,piso:1,seccion:1,posicion:1}, 
      createdAt:new Date().toISOString() 
    };
    if(window.DBX) await DBX.saveUser(tmp);
  }
}

function mostrarRegistroModal() {
  const clave = prompt("Ingrese la clave maestra para continuar:");
  if (clave === null) return; // Cancelado

  const CLAVE_MAESTRA = "temporal"; // üîë c√°mbiala si deseas

  if (clave === CLAVE_MAESTRA) {
    document.getElementById('modalRegistro').classList.remove('hidden');
    document.getElementById('regError').textContent = '';
  } else {
    alert("Clave maestra incorrecta ‚ùå");
  }
}


function cerrarRegistroModal(){ 
  document.getElementById('modalRegistro').classList.add('hidden'); 
}

async function registrarUsuarioModal(){
  const nombre = document.getElementById('regNombre').value.trim();
  const usuario = document.getElementById('regUsuario').value.trim();
  const pass = document.getElementById('regPassword').value;
  const pass2 = document.getElementById('regPasswordConfirm').value;
  const err = document.getElementById('regError'); 
  err.textContent='';
  
  if(!nombre||!usuario||!pass){ 
    err.textContent='Completa todos los campos'; 
    return; 
  }
  if(pass.length<4){ 
    err.textContent='La contrase√±a debe tener al menos 4 caracteres'; 
    return; 
  }
  if(pass !== pass2){ 
    err.textContent='Las contrase√±as no coinciden'; 
    return; 
  }
  
  const exists = await DBX.getUser(usuario);
  if(exists){ 
    err.textContent='Usuario ya existe'; 
    return; 
  }
  
  await DBX.saveUser({ 
    usuario, 
    nombre, 
    password:pass, 
    datos:[], 
    contadorUb:{estanteria:1,piso:1,seccion:1,posicion:1}, 
    createdAt:new Date().toISOString() 
  });
  
  cerrarRegistroModal(); 
  mostrarToast('Usuario registrado ‚úÖ');
}

async function iniciarSesion(){
  const u = document.getElementById('loginUsuario').value.trim();
  const p = document.getElementById('loginPassword').value;
  const err = document.getElementById('loginError'); 
  err.textContent='';
  
  if(!u||!p){ 
    err.textContent='Completa usuario y contrase√±a'; 
    return; 
  }
  
  const user = await DBX.getUser(u);
  if(!user){ 
    err.textContent='Usuario no encontrado'; 
    return; 
  }
  if(user.password !== p){ 
    err.textContent='Contrase√±a incorrecta'; 
    return; 
  }
  
  usuarioActual = u;
  datos = user.datos || [];
  datosVisibles = [...datos];
  contadorUb = user.contadorUb || {estanteria:1,piso:1,seccion:1,posicion:1};
  
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  document.getElementById('currentUserName').textContent = `${user.nombre || usuarioActual}`;
  
  if(usuarioActual === 'admin') {
    document.getElementById('btnAdminPanel').classList.remove('hidden');
  } else {
    document.getElementById('btnAdminPanel').classList.add('hidden');
  }
  
  recomputeInnerHeight();
  renderVisibleRows();
  document.getElementById('totalCount').textContent = datos.length;
  mostrarToast('Sesi√≥n iniciada ‚úÖ');
}

async function cerrarSesion(){
  await persistUserData();
  usuarioActual = null; 
  datos = []; 
  datosVisibles = []; 
  
  document.getElementById('main').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
  document.getElementById('loginUsuario').value=''; 
  document.getElementById('loginPassword').value='';
}

/* cambiar clave */
function abrirCambiarClave(){ 
  document.getElementById('modalCambiar').classList.remove('hidden'); 
  document.getElementById('changePassMsg').textContent=''; 
}

function cerrarCambiarClave(){ 
  document.getElementById('modalCambiar').classList.add('hidden'); 
}

async function cambiarClave(){
  const cur = document.getElementById('curPass').value;
  const neu = document.getElementById('newPass').value;
  const conf = document.getElementById('confirmNewPass').value;
  const msg = document.getElementById('changePassMsg'); 
  msg.textContent=''; 
  msg.style.color='#d63333';
  
  if(!usuarioActual){ 
    msg.textContent='No hay sesi√≥n activa'; 
    return; 
  }
  
  const user = await DBX.getUser(usuarioActual);
  if(user.password !== cur){ 
    msg.textContent='Contrase√±a actual incorrecta'; 
    return; 
  }
  if(neu.length<4){ 
    msg.textContent='La nueva contrase√±a debe tener al menos 4 caracteres'; 
    return; 
  }
  if(neu !== conf){ 
    msg.textContent='Las contrase√±as no coinciden'; 
    return; 
  }
  
  await DBX.saveUser({ ...user, password:neu });
  msg.style.color='#0a9b5b'; 
  msg.textContent='Contrase√±a actualizada ‚úÖ';
  setTimeout(()=> cerrarCambiarClave(), 1200);
}


async function confirmarEliminacionPerfil() {
  try {
    // Espera que la base de datos est√© lista
    if (!DBX.db) {
      await DBX.init();
    }

    const usuario = prompt("üîë Ingrese su nombre de usuario para eliminar su perfil:");
    if (!usuario) return;

    const pass = prompt("Ingrese su contrase√±a para confirmar:");
    if (!pass) return;

    const user = await DBX.getUser(usuario);
    if (!user) {
      alert("Usuario no encontrado ‚ùå");
      return;
    }

    if (user.password !== pass) {
      alert("Contrase√±a incorrecta ‚ùå");
      return;
    }

    const confirmar = confirm(
      `‚ö†Ô∏è ¬øEst√° seguro de eliminar el perfil "${usuario}" de la plataforma?\n\nEsta acci√≥n no se puede deshacer.`
    );
    if (!confirmar) return;

    await DBX.deleteUser(usuario);
    mostrarToast("Perfil eliminado correctamente ‚úÖ");
    alert(`El perfil "${usuario}" ha sido eliminado de la plataforma ‚úÖ`);
  } catch (err) {
    console.error("Error al eliminar perfil:", err);
    alert("Ocurri√≥ un error al intentar eliminar el perfil ‚ö†Ô∏è");
  }
}


/* Admin panel */
async function abrirModalAdmin(){
  if(usuarioActual !== 'admin'){ 
    mostrarToast('Acceso denegado'); 
    return; 
  }
  
  const list = document.getElementById('adminList'); 
  list.innerHTML = '';
  const users = await DBX.getAllUsers();
  
  users.forEach(udata=>{
    const username = udata.usuario;
    const el = document.createElement('div'); 
    el.style.display='flex'; 
    el.style.justifyContent='space-between'; 
    el.style.padding='8px 6px'; 
    el.style.borderBottom='1px solid #eef5fb';
    
    const left = document.createElement('div'); 
    left.innerHTML = `<strong>${udata.nombre}</strong><div style="color:#556b78;font-size:.9rem">${username} ¬∑ Reg: ${udata.createdAt? new Date(udata.createdAt).toLocaleDateString(): 'N/A'}</div>`;
    
    const actions = document.createElement('div');
    const btnReset = document.createElement('button'); 
    btnReset.className='btn muted'; 
    btnReset.textContent='Restablecer clave'; 
    btnReset.onclick = async ()=> { 
      await DBX.saveUser({...udata, password:'1234'}); 
      mostrarToast('Clave restablecida'); 
    };
    
    const btnDel = document.createElement('button'); 
    btnDel.className='btn danger'; 
    btnDel.style.marginLeft='8px'; 
    btnDel.textContent='Eliminar'; 
    btnDel.onclick = async ()=> { 
      if(username==='admin'){ 
        alert('No puedes eliminar admin'); 
        return; 
      } 
      if(confirm('Eliminar usuario?')){ 
        await DBX.deleteUser(username); 
        abrirModalAdmin(); 
        mostrarToast('Usuario eliminado'); 
      } 
    };
    
    actions.appendChild(btnReset); 
    if(username!=='admin') actions.appendChild(btnDel);
    el.appendChild(left); 
    el.appendChild(actions); 
    list.appendChild(el);
  });
  
  document.getElementById('modalAdmin').classList.remove('hidden');
}

/* -------- Data helpers (persist) -------- */
async function persistUserData(){ 
  if(!usuarioActual) return;
  
  const user = await DBX.getUser(usuarioActual) || { 
    usuario: usuarioActual, 
    nombre: usuarioActual, 
    password:'1234', 
    datos:[], 
    contadorUb:{estanteria:1,piso:1,seccion:1,posicion:1} 
  };
  
  user.datos = datos;
  user.contadorUb = contadorUb;
  user.lastModified = new Date().toISOString();
  await DBX.saveUser(user);
}

function findGlobalRecord(record) {
  return datos.find(d => 
    d.item === record.item && 
    d.dim === record.dim && 
    d.fechaIngresoRaw === record.fechaIngresoRaw
  );
}

/* -------- Generar ubicaci√≥n -------- */
function generarUbicacion(){
  if(!contadorUb) contadorUb = {estanteria:1,piso:1,seccion:1,posicion:1};
  
  contadorUb.posicion++;
  if(contadorUb.posicion>10){ 
    contadorUb.posicion=1; 
    contadorUb.seccion++; 
    if(contadorUb.seccion>5){ 
      contadorUb.seccion=1; 
      contadorUb.piso++; 
      if(contadorUb.piso>5){ 
        contadorUb.piso=1; 
        contadorUb.estanteria++; 
      } 
    } 
  }
  
  saveDBDebounced();
  return `${contadorUb.estanteria}.${contadorUb.piso}.${contadorUb.seccion}.${contadorUb.posicion}`;
}

/* -------- Ingresar registro -------- */
function ingresarDim(){
  if(!usuarioActual){ 
    alert('Inicia sesi√≥n'); 
    return; 
  }
  
  const item = document.getElementById('item').value.trim();
  const dim = document.getElementById('numeroDim').value.trim();
  const acta = document.getElementById('acta').value.trim();
  const fecha = document.getElementById('fechaSeleccionadaInput').value;
  const desc = document.getElementById('descripcion').value.trim();
  const cant = Number(document.getElementById('cantidad').value || 0);
  
  if(!item || !dim || !desc || !cant || !fecha){ 
    alert('Completa Item, DIM, Descripci√≥n, Cantidad y Fecha'); 
    return; 
  }
  
  const ubic = generarUbicacion();
  const rec = { 
    item, 
    dim, 
    acta, 
    fechaRaw: fecha, 
    descripcion: desc, 
    cantidad: cant, 
    ubicacion: ubic, 
    fechaIngresoRaw: new Date().toISOString(), 
    seleccionado:false, 
    photo: '', 
    video: '' /* campo para video (DataURL) */
  };
  
  datos.push(rec);
  if (document.getElementById('volverContainer') && document.getElementById('volverContainer').classList.contains('hidden')) {
    datosVisibles.push(rec);
  }
  
  persistUserData();
  recomputeInnerHeight();
  renderVisibleRows();
  document.getElementById('totalCount').textContent = datos.length;
  limpiarInputs();
  mostrarToast('Registro ingresado ‚úÖ');
  intentarEscribirExcelVigilado();
}

function limpiarInputs(){ 
  ['item','numeroDim','acta','fechaSeleccionadaInput','descripcion','cantidad'].forEach(id=> {
    document.getElementById(id).value = (id==='cantidad') ? '0' : '';
  });
}

/* -------- Virtualized rendering -------- */
function recomputeInnerHeight(){ 
  inner.style.height = (datosVisibles.length * ROW_HEIGHT) + 'px';
  document.getElementById('totalCount').textContent = datos.length; 
}

function onScrollViewport(){ 
  requestAnimationFrame(renderVisibleRows); 
}

function renderVisibleRows(){
  const dataToRender = datosVisibles;
  const scrollTop = viewport.scrollTop;
  const viewportHeight = viewport.clientHeight;
  const totalRows = dataToRender.length;
  const start = Math.max(0, Math.floor(scrollTop/ROW_HEIGHT) - BUFFER_ROWS);
  const end = Math.min(totalRows, Math.ceil((scrollTop + viewportHeight)/ROW_HEIGHT) + BUFFER_ROWS);
  
  inner.innerHTML = '';
  
  for(let i=start;i<end;i++){
    const d = dataToRender[i];
    const row = document.createElement('div'); 
    row.className='row'; 
    row.style.top = (i*ROW_HEIGHT)+'px';
    
    row.innerHTML = `
      <div class="col-checkbox"><input type="checkbox" data-idx="${i}" ${d.seleccionado ? 'checked' : ''}></div>
      <div class="col-item">${escapeHtml(d.item)}</div>
      <div class="col-dim">${escapeHtml(d.dim)}</div>
      <div class="col-acta">${escapeHtml(d.acta||'')}</div>
      <div class="col-fecha">${escapeHtml(formatDDMMYYYYAny(d.fechaRaw))}</div>
      <div class="col-desc">${escapeHtml(d.descripcion||'')}</div>
      <div class="col-cantidad">${escapeHtml(d.cantidad||0)}</div>
      <div class="col-ubic">${escapeHtml(d.ubicacion||'')}</div>
      <div class="col-photo">${d.photo ? '<div class="photo-placeholder">Foto</div>' : '<div class="photo-placeholder">No</div>'}</div>
      <div class="col-ingreso">${escapeHtml(formatDDMMYYYYAny(d.fechaIngresoRaw))}</div>
      <div class="col-actions">
        <button class="fab camera ripple" title="Tomar / Reemplazar foto" data-idx="${i}">üì∏</button>
        <button class="fab video ripple" title="Grabar / Reemplazar video" data-idx="${i}">üé•</button>
        <button class="fab view ripple" title="Ver multimedia" data-idx="${i}">üëÅÔ∏è</button>
        <button class="fab edit ripple" title="Editar foto/video" data-idx="${i}">‚úèÔ∏è</button>
        <button class="fab delete ripple" title="Eliminar foto/video" data-idx="${i}">üóëÔ∏è</button>
      </div>
    `;
    inner.appendChild(row);
  }
  
  // attach events
  inner.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.onchange = (e)=>{ 
      const visibleIdx = Number(e.target.dataset.idx); 
      if(!isNaN(visibleIdx)){ 
        const record = datosVisibles[visibleIdx];
        record.seleccionado = e.target.checked; 
        
        const globalRecord = findGlobalRecord(record);
        if(globalRecord) globalRecord.seleccionado = e.target.checked;

        saveDBDebounced(); 
      } 
    };
  });
  
  inner.querySelectorAll('button[data-idx]').forEach(btn=>{
    const idx = Number(btn.dataset.idx);
    const title = (btn.getAttribute('title') || '').toLowerCase();
    if(title.includes('tomar')) btn.onclick = ()=> takePhotoFor(idx);
    else if(title.includes('grabar')) btn.onclick = ()=> grabarVideoFor(idx);
    else if(title.includes('ver')) btn.onclick = ()=> verMultimediaFor(idx);
    else if(title.includes('editar')) btn.onclick = ()=> editarMultimediaFor(idx);
    else if(title.includes('eliminar')) btn.onclick = ()=> eliminarMultimediaFor(idx);
  });
}

function escapeHtml(s=''){ 
  return String(s).replace(/[&<>"']/g, m=> ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[m])); 
}

/* selection handlers */
document.getElementById('selectAll').addEventListener('change', (e)=> {
  const v = e.target.checked;
  for(let i=0;i<datosVisibles.length;i++){
    const visibleRecord = datosVisibles[i];
    visibleRecord.seleccionado = v;
    
    const globalRecord = findGlobalRecord(visibleRecord);
    if (globalRecord) globalRecord.seleccionado = v;
  }
  
  saveDBDebounced();
  renderVisibleRows();
});

function eliminarSeleccionados(){
  const count = datos.filter(d=>d.seleccionado).length;
  if(!count){ 
    alert('No hay seleccionados'); 
    return; 
  }
  if(!confirm(`Eliminar ${count} registros?`)) return;
  
  datos = datos.filter(d=>!d.seleccionado);
  datosVisibles = [...datos];
  persistUserData(); 
  recomputeInnerHeight(); 
  renderVisibleRows(); 
  mostrarToast('Registros eliminados');
}

/* -------- Funciones de Consulta -------- */
function ejecutarConsulta(filterFn, mensajeError) {
  if (!datos || datos.length === 0) {
    mostrarToast('No hay registros para consultar.');
    return;
  }

  const volverContainer = document.getElementById('volverContainer');
  const resultados = datos.filter(filterFn);

  datosVisibles = resultados;
  recomputeInnerHeight();
  renderVisibleRows();

  if (resultados.length === 0) {
    mostrarToast(mensajeError);
    if (volverContainer) volverContainer.classList.add('hidden');
    return;
  }

  if (volverContainer) volverContainer.classList.remove('hidden');
  viewport.scrollTop = 0;
  mostrarToast(`Encontrados ${resultados.length} registros. Resultados filtrados. ‚úÖ`);
}

function consultarPorDim() {
  const dim = document.getElementById('numeroDim').value.trim().toLowerCase();
  if (!dim) { 
    mostrarToast('Introduce un N√∫mero DIM para consultar.'); 
    return; 
  }
  ejecutarConsulta(
    d => String(d.dim).toLowerCase().includes(dim),
    'No se encontraron registros con ese N√∫mero DIM.'
  );
}

function consultarPorActa() {
  const acta = document.getElementById('acta').value.trim().toLowerCase();
  if (!acta) { 
    mostrarToast('Introduce un N¬∞ Acta para consultar.'); 
    return; 
  }
  ejecutarConsulta(
    d => String(d.acta || '').toLowerCase().includes(acta),
    'No se encontraron registros con ese N¬∞ Acta.'
  );
}

function consultarPorUbicacion() {
  const ubicacion = prompt('Introduce la Ubicaci√≥n a consultar (ej: 1.2.3.4):');
  if (!ubicacion) return;
  const u = ubicacion.trim().toLowerCase();
  ejecutarConsulta(
    d => String(d.ubicacion || '').toLowerCase().includes(u),
    'No se encontraron registros con esa Ubicaci√≥n.'
  );
}

function consultarPorAnio() {
  const anio = prompt('Introduce el A√±o de Egreso/Fecha para consultar (ej: 2023):');
  if (!anio) return;
  
  const anioStr = String(anio).trim();
  if (anioStr.length !== 4 || isNaN(Number(anioStr))) {
    mostrarToast('Introduce un a√±o v√°lido de 4 d√≠gitos.');
    return;
  }

  // Mostrar algunos ejemplos de fechas para debug (solo las primeras 3)
  console.log('=== DEBUG: Ejemplos de fechas en la base de datos ===');
  datos.slice(0, 3).forEach((d, i) => {
    console.log(`Registro ${i+1}: fechaRaw =`, d.fechaRaw, '| tipo:', typeof d.fechaRaw);
  });

  ejecutarConsulta(
    d => {
      const rawDate = d.fechaRaw;
      if (!rawDate) return false;
      
      try {
        const fechaStr = String(rawDate).trim();
        
        // Caso 1: Formato YYYY-MM-DD (ISO) - el a√±o est√° al inicio
        if (fechaStr.match(/^\d{4}-\d{2}-\d{2}/)) {
          const yearMatch = fechaStr.substring(0, 4) === anioStr;
          if (yearMatch) console.log('Encontrado (ISO):', fechaStr);
          return yearMatch;
        }
        
        // Caso 2: Formato DD/MM/YYYY - el a√±o est√° al final
        if (fechaStr.includes('/')) {
          const partes = fechaStr.split('/');
          if (partes.length === 3) {
            const yearMatch = partes[2].trim() === anioStr;
            if (yearMatch) console.log('Encontrado (DD/MM/YYYY):', fechaStr);
            return yearMatch;
          }
        }
        
        // Caso 3: Formato MM/DD/YYYY (formato americano)
        if (fechaStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
          const partes = fechaStr.split('/');
          if (partes.length === 3) {
            const yearMatch = partes[2].trim() === anioStr;
            if (yearMatch) console.log('Encontrado (MM/DD/YYYY):', fechaStr);
            return yearMatch;
          }
        }
        
        // Caso 4: N√∫mero serial de Excel (convertir)
        if (!isNaN(Number(fechaStr))) {
          const d = excelSerialToDate(Number(fechaStr));
          if (d) {
            const yearMatch = d.getFullYear() === Number(anioStr);
            if (yearMatch) console.log('Encontrado (Serial Excel):', fechaStr, '‚Üí', d);
            return yearMatch;
          }
        }
        
        // Caso 5: Objeto Date directo
        if (rawDate instanceof Date) {
          const yearMatch = rawDate.getFullYear() === Number(anioStr);
          if (yearMatch) console.log('Encontrado (Date object):', rawDate);
          return yearMatch;
        }
        
        // Caso 6: Intentar parsear como Date
        const dateObj = new Date(rawDate);
        if (!isNaN(dateObj.getTime())) {
          const yearMatch = dateObj.getFullYear() === Number(anioStr);
          if (yearMatch) console.log('Encontrado (parseado):', fechaStr, '‚Üí', dateObj);
          return yearMatch;
        }
        
        // Caso 7: B√∫squeda simple del a√±o en el string (√∫ltimo recurso)
        const simpleMatch = fechaStr.includes(anioStr);
        if (simpleMatch) console.log('Encontrado (b√∫squeda simple):', fechaStr);
        return simpleMatch;
      } catch (e) {
        console.error('Error procesando fecha:', rawDate, e);
        return false;
      }
    },
    `No se encontraron registros en el a√±o ${anio}.`
  );
}

function volverATodosLosRegistros() {
  const volverContainer = document.getElementById('volverContainer');

  if (datosVisibles.length === datos.length && (!volverContainer || volverContainer.classList.contains('hidden'))) {
    mostrarToast('Ya est√°s viendo todos los registros.');
    return;
  }

  datosVisibles = [...datos];
  recomputeInnerHeight();
  renderVisibleRows();
  if (volverContainer) volverContainer.classList.add('hidden');
  viewport.scrollTop = 0;
  mostrarToast('Vista restaurada a todos los registros. üîÑ');
}

function mostrarTodos(){ 
  volverATodosLosRegistros();
}

/* -------- Photo handling (existente) -------- */
const photoInputElem = document.getElementById('photoInput');

async function takePhotoFor(visibleIdx) {
  if (typeof visibleIdx !== 'number') return;
  
  const record = datosVisibles[visibleIdx];
  if (!record) return;

  photoInputElem.value = '';
  photoInputElem.onchange = async (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    try {
      const dataUrl = await fileToCompressedDataUrl(file, 1280, 0.8);
      
      record.photo = dataUrl;
      
      const globalRecord = findGlobalRecord(record);
      if (globalRecord) globalRecord.photo = dataUrl;

      await persistUserData();
      renderVisibleRows();
      mostrarToast('Foto guardada ‚úÖ');
    } catch (e) {
      console.error(e);
      mostrarToast('Error al guardar la foto ‚ö†Ô∏è');
    } finally {
      photoInputElem.onchange = null;
    }
  };
  photoInputElem.click();
}

function viewPhotoFor(visibleIdx) {
  if (!datosVisibles[visibleIdx] || !datosVisibles[visibleIdx].photo) { 
    mostrarToast('No hay foto'); 
    return; 
  }
  document.getElementById('viewPhotoImg').src = datosVisibles[visibleIdx].photo;
  document.getElementById('modalViewPhoto').classList.remove('hidden');
}

function deletePhotoFor(visibleIdx) {
  const record = datosVisibles[visibleIdx];
  if (!record || !record.photo) { 
    mostrarToast('No hay foto'); 
    return; 
  }
  if (!confirm('¬øEliminar la foto de este registro?')) return;
  
  record.photo = '';
  
  const globalRecord = findGlobalRecord(record);
  if (globalRecord) globalRecord.photo = '';
  
  persistUserData();
  renderVisibleRows();
  mostrarToast('Foto eliminada ‚úÖ');
}

async function fileToCompressedDataUrl(file, maxSide = 1280, quality = 0.8) {
  const img = await createImageBitmap(file);
  const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
  const canvas = document.createElement('canvas');
  canvas.width = Math.round(img.width * scale);
  canvas.height = Math.round(img.height * scale);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg', quality);
  img.close?.();
  return dataUrl;
}

/* ===== Manejo de video (nuevas funciones) ===== */

async function grabarVideoFor(visibleIdx) {
  if (typeof visibleIdx !== "number") return;
  const record = datosVisibles[visibleIdx];
  if (!record) return;

  if (!navigator.mediaDevices || !window.MediaRecorder) {
    alert("Tu navegador no soporta grabaci√≥n de video (MediaRecorder).");
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    mediaRecorder.ondataavailable = (e) => { if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      try {
        const blob = new Blob(chunks, { type: "video/webm" });
        const reader = new FileReader();
        reader.onloadend = async () => {
          record.video = reader.result; // DataURL (base64)
          const globalRecord = findGlobalRecord(record);
          if (globalRecord) globalRecord.video = reader.result;
          await persistUserData();
          renderVisibleRows();
          mostrarToast("üé¨ Video guardado correctamente");
        };
        reader.readAsDataURL(blob);
      } catch(e){
        console.error("Error procesando video:", e);
        mostrarToast("Error guardando video");
      } finally {
        stream.getTracks().forEach((t) => t.stop());
      }
    };

    mediaRecorder.start();
    mostrarToast("üé• Grabando... pulsa Aceptar cuando quieras detener.");
    // Simple UX: usamos alert para esperar al usuario y luego detener
    await new Promise(res => setTimeout(res, 300)); // ligero retardo para evitar stop inmediato
    alert("La grabaci√≥n est√° activa. Pulsa Aceptar para detener la grabaci√≥n.");
    mediaRecorder.stop();
  } catch (err) {
    console.error(err);
    mostrarToast("Error al grabar video ‚ö†Ô∏è");
  }
}

function verVideoFor(visibleIdx) {
  const record = datosVisibles[visibleIdx];
  if (!record || !record.video) {
    mostrarToast("No hay video guardado");
    return;
  }
  const videoModal = document.createElement("div");
  videoModal.className = "overlay";
  videoModal.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true">
      <h3>üé• Vista de video</h3>
      <video controls style="max-width:100%;border-radius:8px;">
        <source src="${record.video}" type="video/webm">
        Tu navegador no soporta videos embebidos.
      </video>
      <div style="text-align:center;margin-top:10px">
        <button class="btn muted" onclick="this.closest('.overlay').remove()">Cerrar</button>
      </div>
    </div>
  `;
  document.body.appendChild(videoModal);
}

function eliminarVideoFor(visibleIdx) {
  const record = datosVisibles[visibleIdx];
  if (!record || !record.video) {
    mostrarToast("No hay video para eliminar");
    return;
  }
  if (!confirm("¬øEliminar el video de este registro?")) return;
  record.video = "";
  const globalRecord = findGlobalRecord(record);
  if (globalRecord) globalRecord.video = "";
  persistUserData();
  renderVisibleRows();
  mostrarToast("Video eliminado ‚úÖ");
}

/* Funci√≥n que decide qu√© ver: video tiene prioridad, si no hay video muestra foto */
function verMultimediaFor(visibleIdx) {
  const record = datosVisibles[visibleIdx];
  if (!record) { mostrarToast("Registro no v√°lido"); return; }
  if (record.video) { verVideoFor(visibleIdx); return; }
  if (record.photo) { viewPhotoFor(visibleIdx); return; }
  mostrarToast("No hay foto ni video en este registro");
}

/* Editar multimedia: elige si editar foto o video */
function editarMultimediaFor(visibleIdx) {
  const record = datosVisibles[visibleIdx];
  if (!record) { mostrarToast("Registro no v√°lido"); return; }
  const choice = prompt("Editar (1) Foto, (2) Video - escribe 1 o 2:");
  if (!choice) return;
  if (choice.trim() === '1') {
    takePhotoFor(visibleIdx);
  } else if (choice.trim() === '2') {
    grabarVideoFor(visibleIdx);
  } else {
    mostrarToast("Opci√≥n inv√°lida");
  }
}

/* Eliminar multimedia: opciones */
function eliminarMultimediaFor(visibleIdx) {
  const record = datosVisibles[visibleIdx];
  if (!record) { mostrarToast("Registro no v√°lido"); return; }
  const opt = prompt("Eliminar: (1) Foto, (2) Video, (3) Registro completo. Escribe 1/2/3:");
  if (!opt) return;
  if (opt.trim() === '1') {
    deletePhotoFor(visibleIdx);
  } else if (opt.trim() === '2') {
    eliminarVideoFor(visibleIdx);
  } else if (opt.trim() === '3') {
    if(!confirm('¬øEliminar registro completo? Esta acci√≥n es irreversible.')) return;
    // eliminar registro global y visible
    const recordToRemove = record;
    const globalIndex = datos.findIndex(d => 
      d.item === recordToRemove.item && d.dim === recordToRemove.dim && d.fechaIngresoRaw === recordToRemove.fechaIngresoRaw
    );
    if (globalIndex !== -1) datos.splice(globalIndex, 1);
    datosVisibles.splice(visibleIdx, 1);
    persistUserData();
    recomputeInnerHeight();
    renderVisibleRows();
    mostrarToast('Registro eliminado ‚úÖ');
  } else {
    mostrarToast("Opci√≥n inv√°lida");
  }
}

/* -------- Import Excel (existente) -------- */
const progressCard = document.getElementById('progressCard');
const progressFill = document.getElementById('progressFill');

function handleImportEvent(e){ 
  const f = e.target.files && e.target.files[0]; 
  if(!f) return; 
  importExcelFile(f); 
  e.target.value=''; 
}

function cancelImport(){ 
  importAbort.aborted = true; 
  progressCard.classList.add('hidden'); 
  if(progressFill) progressFill.style.width='0%'; 
  importAbort.aborted=false; 
  mostrarToast('Importaci√≥n cancelada'); 
}

async function importExcelFile(file){
  try{
    progressCard.classList.remove('hidden');
    if(progressFill) progressFill.style.width='0%';
    importAbort.aborted = false;
    
    const ab = await file.arrayBuffer();
    const workbook = XLSX.read(ab, { type:'array', cellDates:true });
    const ws = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
    
    if(!json || !json.length){ 
      alert('Archivo vac√≠o o inv√°lido'); 
      progressCard.classList.add('hidden'); 
      return; 
    }
    
    const CHUNK = 300;
    const total = json.length;
    let i = 0;
    const nuevos = [];
    
    while(i < total){
      if(importAbort.aborted) return;
      const end = Math.min(i + CHUNK, total);
      
      for(let j=i;j<end;j++){
        const row = json[j];
        const r = {
          item: String(row['# Item'] || row['Item'] || ''),
          dim: String(row['N√∫mero DIM'] || row['N√∫meroDim'] || row['DIM'] || ''),
          acta: String(row['Acta'] || row['# Acta'] || ''),
          fechaRaw: normalizeExcelDateCell(row['Fecha']),
          descripcion: String(row['Descripci√≥n'] || row['Descripcion'] || row['Description'] || ''),
          cantidad: Number(row['Cantidad'] || row['Qty'] || 0),
          ubicacion: String(row['Ubicaci√≥n'] || row['Ubicacion'] || '') || generarUbicacion(),
          fechaIngresoRaw: normalizeExcelDateCell(row['Fecha Ingreso']) || new Date().toISOString(),
          seleccionado:false,
          photo:'',
          video:''
        };
        if(r.item && r.dim) nuevos.push(r);
      }
      
      i = end;
      if(progressFill) progressFill.style.width = Math.round((i/total)*100) + '%';
      await new Promise(res => setTimeout(res, 40));
    }
    
    const replace = confirm(`Se detectaron ${nuevos.length} registros. Reemplazar existentes? (Cancelar = agregar)`);
    
    if(replace){ 
      datos = nuevos; 
    } else {
      const mapa = new Map(); 
      datos.forEach(d=> mapa.set(`${d.dim}||${d.item}`, d));
      nuevos.forEach(n=>{
        const key = `${n.dim}||${n.item}`;
        if(mapa.has(key)){
          const ex = mapa.get(key);
          ex.descripcion = n.descripcion || ex.descripcion;
          ex.cantidad = n.cantidad || ex.cantidad;
          ex.ubicacion = n.ubicacion || ex.ubicacion;
          if(n.fechaRaw) ex.fechaRaw = n.fechaRaw;
        } else datos.push(n);
      });
    }
    
    datosVisibles = [...datos];
    
    if(window.DBX && DBX.setLastImported) {
      DBX.setLastImported({ 
        name:file.name, 
        timestamp:new Date().toISOString(), 
        count: Math.min(nuevos.length,1000) 
      });
    }
    
    persistUserData(); 
    recomputeInnerHeight(); 
    renderVisibleRows();
    
    if(progressFill) progressFill.style.width = '100%';
    setTimeout(()=> progressCard.classList.add('hidden'), 400);
    mostrarToast('Importaci√≥n completada ‚úÖ', 2200);
    document.getElementById('totalCount').textContent = datos.length;
  }catch(err){ 
    console.error(err); 
    alert('Error importando Excel'); 
    progressCard.classList.add('hidden'); 
    if(progressFill) progressFill.style.width='0%'; 
  }
}

function normalizeExcelDateCell(cell){
  if(cell === undefined || cell === null || cell === '') return '';
  if(cell instanceof Date) return cell.toISOString().split('T')[0];
  if(!isNaN(Number(cell))){
    const d = excelSerialToDate(Number(cell));
    if(d) return d.toISOString().split('T')[0];
  }
  return String(cell);
}

/* -------- Export / backup (existente) -------- */
function exportarExcel(){
  if(!usuarioActual){ 
    alert('Inicia sesi√≥n'); 
    return; 
  }
  
  try{
    const encabezados = ['# Item','N√∫mero DIM','Acta','Fecha','Descripci√≥n','Cantidad','Ubicaci√≥n','Fecha Ingreso'];
    const filas = (datos||[]).map(d=>({
      '# Item': d.item||'',
      'N√∫mero DIM': d.dim||'',
      'Acta': d.acta||'',
      'Fecha': d.fechaRaw || '',
      'Descripci√≥n': d.descripcion||'',
      'Cantidad': Number(d.cantidad||0),
      'Ubicaci√≥n': d.ubicacion||'',
      'Fecha Ingreso': d.fechaIngresoRaw || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(filas, { header:encabezados });
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    XLSX.writeFile(wb, `UTNL_${usuarioActual}_${new Date().toISOString().split('T')[0]}.xlsx`);
    mostrarToast('Excel exportado ‚úÖ');
  }catch(e){ 
    console.error(e); 
    alert('Error exportando Excel'); 
  }
}

async function exportarBackupDB(){
  const all = await DBX.getAllUsers();
  const blob = new Blob([JSON.stringify({ 
    usuarios: all, 
    exportedAt: new Date().toISOString() 
  }, null, 2)], { type:'application/json' });
  
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  a.download = `UTNL_backup_${new Date().toISOString().split('T')[0]}.json`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove();
  mostrarToast('Backup exportado ‚úÖ');
}

function importarBackupDB(e){
  const file = e.target.files[0]; 
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(evt){
    try{
      const parsed = JSON.parse(evt.target.result);
      if(!parsed || !parsed.usuarios){ 
        alert('JSON inv√°lido'); 
        return; 
      }
      if(!confirm('Se importar√° la base completa desde JSON y reemplazar√° la actual. ¬øContinuar?')) return;
      
      const adminExists = await DBX.getUser('admin');
      if (adminExists) await DBX.deleteUser('admin');
      
      for(const u of parsed.usuarios){
        await DBX.saveUser(u);
      }
      await DBX.init();
      mostrarToast('Backup importado ‚úÖ');
      
      if(usuarioActual){
        const u = await DBX.getUser(usuarioActual);
        if(u){ 
          datos = u.datos || []; 
          datosVisibles = [...datos]; 
          recomputeInnerHeight(); 
          renderVisibleRows(); 
        }
      }
    }catch(err){ 
      console.error(err); 
      alert('Error leyendo JSON'); 
    } finally { 
      e.target.value=''; 
    }
  };
  reader.readAsText(file);
}

/* -------- File System Access: watch file (existente) -------- */
async function requestFileHandle(){
  try{
    const [handle] = await window.showOpenFilePicker({ 
      types:[{ 
        description:'Excel', 
        accept: { 
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'], 
          'application/vnd.ms-excel': ['.xls'] 
        } 
      }], 
      multiple:false 
    });
    return handle;
  }catch(e){ 
    console.warn('No file chosen', e); 
    return null; 
  }
}

async function toggleWatch(){
  if(!('showOpenFilePicker' in window)){ 
    alert('Tu navegador no soporta vigilancia autom√°tica. Usa importar manual.'); 
    return; 
  }
  if(excelFileHandle){ 
    stopWatching(); 
    return; 
  }
  
  const handle = await requestFileHandle(); 
  if(!handle) return;
  
  excelFileHandle = handle;
  document.getElementById('watchBtn').classList.add('hidden');
  document.getElementById('stopWatchBtn').classList.remove('hidden');
  updateTopPills();
  
  watchInterval = setInterval(async ()=>{
    try{
      const file = await handle.getFile();
      const lm = file.lastModified || 0;
      if(!window._lastLM) window._lastLM = lm;
      if(lm !== window._lastLM){
        window._lastLM = lm;
        await importExcelFile(file);
        mostrarToast('Datos sincronizados desde archivo vigilado üîÑ');
      }
    }catch(e){ 
      console.warn(e); 
    }
  }, WATCH_INTERVAL_MS);
  
  mostrarToast('Vigilancia iniciada üîé');
}

function stopWatching(){
  if(watchInterval) clearInterval(watchInterval);
  watchInterval = null; 
  excelFileHandle = null;
  document.getElementById('watchBtn').classList.remove('hidden');
  document.getElementById('stopWatchBtn').classList.add('hidden');
  updateTopPills();
  mostrarToast('Vigilancia detenida ‚èπÔ∏è');
}

function updateTopPills(){ 
  document.getElementById('filePill').textContent = excelFileHandle ? `Archivo vigilado: (seleccionado)` : 'Archivo vigilado: ninguno'; 
  document.getElementById('syncPill').textContent = excelFileHandle ? 'Sincronizaci√≥n: activa' : 'Sincronizaci√≥n: inactiva'; 
}

function forzarImportDesdeHandle() {
  if (!excelFileHandle) {
    mostrarToast('No hay archivo vigilado activo');
    return;
  }
  excelFileHandle.getFile().then(file => {
    importExcelFile(file);
  }).catch(e => {
    console.error(e);
    mostrarToast('Error al forzar importaci√≥n');
  });
}

/* -------- Writing back to handle (existente) -------- */
let writeDebounceTimer = null;
async function intentarEscribirExcelVigilado(){
  if(!excelFileHandle) return;
  
  if(writeDebounceTimer) clearTimeout(writeDebounceTimer);
  writeDebounceTimer = setTimeout(async ()=>{
    try{
      const opts = { mode:'readwrite' };
      const curr = await excelFileHandle.queryPermission(opts);
      if(curr !== 'granted'){
        const req = await excelFileHandle.requestPermission(opts);
        if(req !== 'granted'){ 
          console.warn('No write permission'); 
          return; 
        }
      }
      await writeExcelToHandle();
      mostrarToast('Archivo vigilado actualizado ‚úÖ');
    }catch(e){ 
      console.warn('No se pudo escribir al archivo vigilado', e); 
    }
  }, 900);
}

async function writeExcelToHandle(){
  if(!excelFileHandle) return;
  
  try{
    const encabezados = ['# Item','N√∫mero DIM','Acta','Fecha','Descripci√≥n','Cantidad','Ubicaci√≥n','Fecha Ingreso'];
    const filas = (datos||[]).map(d=>({
      '# Item': d.item||'',
      'N√∫mero DIM': d.dim||'',
      'Acta': d.acta||'',
      'Fecha': d.fechaRaw || '',
      'Descripci√≥n': d.descripcion||'',
      'Cantidad': Number(d.cantidad||0),
      'Ubicaci√≥n': d.ubicacion||'',
      'Fecha Ingreso': d.fechaIngresoRaw || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(filas, { header:encabezados });
    const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const writable = await excelFileHandle.createWritable();
    await writable.write(wbout);
    await writable.close();
  }catch(e){ 
    console.error('writeExcelToHandle error', e); 
    throw e; 
  }
}

/* ========== INDEXEDDB DATABASE CLASS ========== */
class DBIndexed {
  constructor() {
    this.dbName = 'UTNL_DB_INDEXED_v1';
    this.storeName = 'usuarios';
    this.db = null;
  }

  async init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.dbName, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          const store = db.createObjectStore(this.storeName, { keyPath: 'usuario' });
          store.createIndex('usuario', 'usuario', { unique: true });
        }
      };
      req.onsuccess = (e) => { 
        this.db = e.target.result; 
        resolve(); 
      };
      req.onerror = (e) => reject(e);
    });
  }

  async getUser(usuario) {
    const db = this.db;
    return new Promise((res, rej) => {
      const tx = db.transaction(this.storeName, 'readonly');
      const store = tx.objectStore(this.storeName);
      const req = store.get(usuario);
      req.onsuccess = () => res(req.result || null);
      req.onerror = (e) => rej(e);
    });
  }

  async saveUser(data) {
    const db = this.db;
    return new Promise((res, rej) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);
      const req = store.put(data);
      req.onsuccess = () => res(true);
      req.onerror = (e) => rej(e);
    });
  }

  async deleteUser(usuario) {
    const db = this.db;
    return new Promise((res, rej) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);
      const req = store.delete(usuario);
      req.onsuccess = () => res(true);
      req.onerror = (e) => rej(e);
    });
  }

  async getAllUsers() {
    const db = this.db;
    return new Promise((res, rej) => {
      const tx = db.transaction(this.storeName, 'readonly');
      const store = tx.objectStore(this.storeName);
      const req = store.getAll();
      req.onsuccess = () => res(req.result || []);
      req.onerror = (e) => rej(e);
    });
  }
}

// Crear instancia global
const DBX = new DBIndexed();
DBX.init().then(() => console.log("IndexedDB listo ‚úÖ")).catch(console.error);

/* ========== GUARDADO Y USUARIO ACTUAL ========== */
async function ejecutarGuardadoCompleto() {
  if (!usuarioActual) return;
  try {
    mostrarBarraGuardado();
    await persistUserData();
    await intentarEscribirExcelVigilado();
    mostrarToast("Guardado completo ‚úÖ");
  } catch (e) {
    console.error("Error al guardar:", e);
    mostrarToast("Error al guardar ‚ö†Ô∏è");
  }
}

async function guardarTodoManual() {
  const btn = document.getElementById("btnGuardar");
  if (!btn) return;
  const original = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="btn-spinner"></span> Guardando‚Ä¶`;

  try {
    await ejecutarGuardadoCompleto();
  } finally {
    setTimeout(() => {
      btn.innerHTML = original;
      btn.disabled = false;
    }, 2000);
  }
}

// Barra visual de progreso
function mostrarBarraGuardado() {
  const barra = document.getElementById("barraGuardado");
  if (!barra) return;
  barra.style.width = "0%";
  requestAnimationFrame(() => (barra.style.width = "100%"));
  setTimeout(() => (barra.style.width = "0%"), 2000);
}

// Guardado autom√°tico cada 3 minutos
setInterval(() => {
  if (usuarioActual && Array.isArray(datos) && datos.length > 0) {
    ejecutarGuardadoCompleto();
  }
}, 180000);

</script>
</body>
</html>
