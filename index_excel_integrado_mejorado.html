<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NUEVA LOGISTICA UT - Optimizado y Responsivo</title>
<link rel="icon" href="img/1.jpeg" />
<!-- XLSX (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --blue-700:#1976d2; --blue-500:#4f83ff; --bg:#f6fbff; --card:#fff; --muted:#5b7b93; --danger:#ef5350;
    --ui-padding:16px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:Inter, "Segoe UI", system-ui, Arial; background:linear-gradient(135deg,#e9f2ff 0%,var(--bg) 100%);min-height:100vh;padding:var(--ui-padding);color:#072033; -webkit-font-smoothing:antialiased;}
  .container{max-width:1200px;margin:0 auto}

  /* Card */
  .card{background:var(--card);border-radius:12px;box-shadow:0 10px 30px rgba(10,30,60,0.06);padding:14px;margin-bottom:14px}
  h1{font-size:1.45rem;color:var(--blue-700);margin-bottom:6px}
  p.lead{color:var(--muted);font-size:.95rem;margin-bottom:8px}

  /* Buttons */
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800;color:#fff}
  .btn.primary{background:linear-gradient(135deg,var(--blue-500),var(--blue-700))}
  .btn.info{background:linear-gradient(135deg,#29b6f6,#0288d1)}
  .btn.success{background:linear-gradient(135deg,#00e676,#00c853);color:#022}
  .btn.muted{background:#f1f5f9;color:#072033}
  .btn.danger{background:linear-gradient(135deg,#ff6b6b,#ee5252);color:#fff}

  /* FABs */
  .fab{width:42px;height:42px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 8px 22px rgba(10,30,60,0.12);border:none;cursor:pointer;font-size:18px;color:#fff}
  .fab.camera{background:linear-gradient(135deg,#ffb74d,#ff8a65)}
  .fab.view{background:linear-gradient(135deg,var(--blue-500),var(--blue-700))}
  .fab.edit{background:linear-gradient(135deg,#7e57c2,#5e35b1)}
  .fab.delete{background:linear-gradient(135deg,#ff5252,#e53935)}
  .fab:active{transform:scale(.96)}

  .ripple{position:relative;overflow:hidden}
  .ripple::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle, rgba(255,255,255,0.18) 10%, transparent 10.01%);opacity:0;transform:scale(10);transition:opacity .6s,transform .6s}
  .ripple:active::after{opacity:1;transform:scale(0);transition:0s}

  /* Top header */
  .topbar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .pills{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(6,30,49,0.04);padding:8px 12px;border-radius:999px;font-weight:700;color:#083044}

  /* Forms / Controls */
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:12px}
  label{font-weight:700;font-size:.9rem;color:#123}
  input[type=text],input[type=number],input[type=date],input[type=password]{width:100%;padding:9px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff}

  /* Login centered */
  #loginCard { max-width:720px; margin: 18px auto; display:flex;flex-direction:column; gap:12px; align-items:stretch; }
  #loginCard .inputs { display:flex; gap:8px; flex-wrap:wrap; }
  #loginCard input { min-width: 140px; }

  /* Virtualized table - responsive (adjustable) */
  .table-wrapper { overflow:hidden } /* hide accidental overflow */
  .table-viewport{height:420px;overflow:auto;border-radius:10px;background:var(--card);border:1px solid #eef6ff}
  .table-inner{position:relative;height:0}

  .row{position:absolute;left:0;right:0;display:flex;align-items:center;padding:10px;border-bottom:1px solid #f1f6fa;gap:10px;font-size:.92rem;height:68px}
  /* Use flexible columns (percent-based) so table adjusts to screen width */
  .col-checkbox{flex:0 0 42px;max-width:42px}
  .col-item{flex:0 0 13%; min-width:90px; max-width:220px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-dim{flex:0 0 12%; min-width:80px; max-width:180px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-acta{flex:0 0 10%; min-width:70px; max-width:140px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-fecha{flex:0 0 10%; min-width:80px; max-width:120px}
  .col-desc{flex:1 1 20%; min-width:120px; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .col-cantidad{flex:0 0 8%; min-width:60px; text-align:right}
  .col-ubic{flex:0 0 10%; min-width:90px}
  .col-photo{flex:0 0 9%; min-width:70px; display:flex;align-items:center;justify-content:center}
  .col-ingreso{flex:0 0 12%; min-width:90px}
  .col-actions{flex:0 0 16%; min-width:140px; display:flex;gap:6px;align-items:center;justify-content:flex-end}

  .photo-placeholder{width:72px;height:48px;border-radius:6px;background:#f3f7fb;display:flex;align-items:center;justify-content:center;color:#7793a3;font-weight:800}

  /* Modal & overlay */
  .overlay{position:fixed;inset:0;background:rgba(2,8,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;border-radius:12px;padding:16px;max-width:95%;width:760px;box-shadow:0 20px 50px rgba(0,0,0,0.15)}
  .modal img{max-width:100%;height:auto;border-radius:8px;display:block;margin:0 auto}

  /* compact loader (small + semi-transparent) */
  #smallLoader {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background: rgba(8,16,30,0.55); /* semi-transparent dark */
    color:#fff;
    padding:14px 18px;
    border-radius:12px;
    display:flex;
    align-items:center;
    gap:12px;
    z-index:100000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }
  .small-spinner{width:40px;height:40px;border-radius:50%;border:5px solid rgba(255,255,255,0.14);border-top-color:var(--blue-700);animation:spin .9s linear infinite}
  @keyframes spin { to { transform: rotate(360deg); } }

  /* helpers */
  .hidden{display:none !important}
  .toast{position:fixed;right:18px;top:18px;background:var(--blue-700);color:#fff;padding:10px 14px;border-radius:10px;z-index:99999;font-weight:800}
  @media (max-width:900px){
    .col-item {flex: 0 0 20%}
    .col-dim {flex: 0 0 18%}
    .col-desc {flex: 1 1 25%}
    .col-actions {flex: 0 0 20%}
    .fab{width:36px;height:36px;font-size:14px}
    #loginCard { padding:12px }
  }
  @media (max-width:600px){
    body{padding:10px}
    .controls{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    .col-item{flex: 0 0 24%}
    .col-dim{flex:0 0 22%}
    .col-desc{flex:1 1 28%}
    .col-actions{flex:0 0 26%}
    .col-photo .photo-placeholder{width:56px;height:38px}
    .table-viewport{height:320px}
    .card{padding:12px}
    .btn{padding:8px 10px;font-size:.95rem}
  }
</style>
</head>
<body>
<!-- Small loader (modern, centered, semitransparent) -->
<div id="smallLoader" aria-live="polite" style="display:flex">
  <div class="small-spinner" aria-hidden="true"></div>
  <div style="font-weight:800">Iniciando sistema UT...</div>
</div>

<div class="container" id="app" style="opacity:1;transition:opacity .25s ease">
  <!-- Header -->
  <div class="card" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <img src="img/1.jpeg" style="width:60px;border-radius:8px" alt="logo">
    <div style="min-width:160px">
      <h1>Uni√≥n Temporal - Nueva Log√≠stica</h1>
      <p class="lead">Optimizado ‚Äî Importa Excel, toma fotos por registro y sincroniza localmente.</p>
    </div>
    <div style="margin-left:auto" class="pills">
      <div id="filePill" class="pill">Archivo vigilado: ninguno</div>
      <div id="syncPill" class="pill">Sincronizaci√≥n: inactiva</div>
    </div>
  </div>

  <!-- LOGIN CARD (centered) -->
  <div id="loginCard" class="card" role="region" aria-label="Login">
    <h1 style="text-align:center">Iniciar sesi√≥n</h1>
    <p class="lead" style="text-align:center">Introduce tu usuario y contrase√±a</p>

    <div class="inputs" style="display:flex;gap:8px;justify-content:center">
      <input id="loginUsuario" type="text" placeholder="Usuario" style="flex:1;min-width:160px;max-width:360px">
      <input id="loginPassword" type="password" placeholder="Contrase√±a" style="flex:1;min-width:160px;max-width:360px">
      <button class="btn primary" onclick="iniciarSesion()">Ingresar</button>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="btn info" onclick="mostrarRegistroModal()">Registrar</button>
      <button class="btn muted" onclick="mostrarInfo()">¬øC√≥mo funciona?</button>
    </div>
    <div id="loginError" style="color:#d63333;margin-top:10px;text-align:center"></div>
  </div>

  <!-- MAIN (hidden until login) -->
  <div id="main" class="card hidden" role="main" aria-live="polite">
    <div class="topbar">
      <div>
        <h1 id="panelTitle" style="margin:0">Panel UT</h1>
        <p class="lead" style="margin:0">Control de inventario y sincronizaci√≥n local con Excel</p>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="currentUserName" style="font-weight:900;color:#072033"></div>
        <button id="btnCambiarPass" class="btn muted" onclick="abrirCambiarClave()">üîê Cambiar Clave</button>
        <button id="btnEliminarPerfil" class="btn danger" onclick="eliminarMiPerfil()">üóëÔ∏è Eliminar Perfil</button>
        <button id="btnAdminPanel" class="btn primary hidden" onclick="abrirModalAdmin()">üë• Gestionar Usuarios</button>
        <button class="btn muted" onclick="cerrarSesion()">Salir</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <button id="watchBtn" class="btn info" onclick="toggleWatch()">üîé Vigilar archivo Excel</button>
      <button id="stopWatchBtn" class="btn danger hidden" onclick="stopWatching()">Detener vigilancia</button>
      <button class="btn primary" onclick="document.getElementById('excelFile').click()">üì§ Importar Excel</button>
      <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" onchange="handleImportEvent(event)">
      <button class="btn success" onclick="exportarExcel()">üìÑ Exportar Excel</button>
      <button class="btn muted" onclick="forzarImportDesdeHandle()">Forzar import (vig.)</button>
      <button class="btn muted" onclick="exportarBackupDB()">üì• Exportar backup (JSON)</button>
      <button class="btn muted" onclick="document.getElementById('backupFile').click()">üì§ Importar backup (JSON)</button>
      <input type="file" id="backupFile" accept=".json" style="display:none" onchange="importarBackupDB(event)">
    </div>

    <!-- Controls -->
    <div class="controls">
      <div>
        <label># Item</label>
        <input id="item" type="text" placeholder="ITEM-001">
      </div>
      <div>
        <label>N√∫mero DIM</label>
        <input id="numeroDim" type="text" placeholder="DIM-001">
      </div>
      <div>
        <label>Acta</label>
        <input id="acta" type="text" placeholder="ACT-2025-001">
      </div>
      <div>
        <label>Fecha</label>
        <input id="fechaSeleccionadaInput" type="date">
      </div>
      <div>
        <label>Descripci√≥n</label>
        <input id="descripcion" type="text" placeholder="Descripci√≥n">
      </div>
      <div>
        <label>Cantidad</label>
        <input id="cantidad" type="number" min="0" value="0">
      </div>
    </div>

   <button class="btn primary" onclick="ingresarDim()">‚ûï Ingresar</button>
<button class="btn muted" onclick="mostrarTodos()">Mostrar todos</button>
<button class="btn danger" onclick="eliminarSeleccionados()">üóë Eliminar seleccionados</button>
<button class="btn muted" onclick="mostrarTabla(getUsuarioDatos())">Refrescar vista</button>

<!-- üíæ Nuevo bot√≥n Guardar -->
<button id="btnGuardar" class="btn success ripple" onclick="guardarTodoManual()">
  üíæ Guardar
</button>


    <!-- progress / loader -->
    <div id="progressCard" class="card hidden" style="display:flex;align-items:center;gap:12px">
      <div class="centered"><div class="small-spinner" aria-hidden="true" style="width:36px;height:36px;border-width:4px"></div></div>
      <div style="flex:1">
        <div style="font-weight:800;color:#123">Procesando importaci√≥n...</div>
        <div class="progress-bar" aria-hidden="true" style="margin-top:8px"><div id="progressFill" class="fill" style="width:0%;height:8px;background:linear-gradient(90deg,var(--blue-500),var(--blue-700));border-radius:999px"></div></div>
      </div>
      <div style="margin-left:auto"><button class="btn muted" onclick="cancelImport()">Cancelar</button></div>
    </div>

    <!-- virtualized table -->
    <div class="card table-wrapper">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:900">Registros</div>
        <div style="color:var(--muted)">Total: <span id="totalCount">0</span></div>
      </div>

      <div id="tableHeader" style="display:flex;gap:10px;padding:8px;border-bottom:1px solid #eef6ff;font-weight:800;color:#234;align-items:center">
        <div class="col-checkbox"><input id="selectAll" type="checkbox"></div>
        <div class="col-item"># Item</div>
        <div class="col-dim">N√∫mero DIM</div>
        <div class="col-acta">Acta</div>
        <div class="col-fecha">Fecha Egreso</div>
        <div class="col-desc">Descripci√≥n</div>
        <div class="col-cantidad">Cant.</div>
        <div class="col-ubic">Ubicaci√≥n</div>
        <div class="col-photo">Foto</div>
        <div class="col-ingreso">Fecha Ingreso</div>
        <div class="col-actions">Acciones</div>
      </div>

      <div id="viewport" class="table-viewport" onscroll="onScrollViewport()">
        <div id="inner" class="table-inner"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODALES -->
<!-- View Photo Modal -->
<div id="modalViewPhoto" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Vista de foto</h3>
    <div id="viewPhotoContainer" style="text-align:center">
      <img id="viewPhotoImg" src="" alt="Foto registro">
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button class="btn muted" onclick="cerrarModal('modalViewPhoto')">Cerrar</button>
    </div>
  </div>
</div>

<!-- Registro modal -->
<div id="modalRegistro" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Registrar Usuario</h3>
    <label>Nombre completo</label><input id="regNombre" type="text">
    <label style="margin-top:8px">Usuario (ID)</label><input id="regUsuario" type="text">
    <label style="margin-top:8px">Contrase√±a</label><input id="regPassword" type="password">
    <label style="margin-top:8px">Confirmar contrase√±a</label><input id="regPasswordConfirm" type="password">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn primary" onclick="registrarUsuarioModal()">Registrar</button>
      <button class="btn muted" onclick="cerrarRegistroModal()">Cancelar</button>
    </div>
    <div id="regError" style="color:#d63333;margin-top:8px"></div>
  </div>
</div>

<!-- Cambiar contrase√±a -->
<div id="modalCambiar" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Cambiar contrase√±a</h3>
    <label>Contrase√±a actual</label><input id="curPass" type="password">
    <label style="margin-top:8px">Nueva contrase√±a</label><input id="newPass" type="password">
    <label style="margin-top:8px">Confirmar nueva</label><input id="confirmNewPass" type="password">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn primary" onclick="cambiarClave()">Guardar</button>
      <button class="btn muted" onclick="cerrarCambiarClave()">Cancelar</button>
    </div>
    <div id="changePassMsg" style="margin-top:8px"></div>
  </div>
</div>

<!-- Admin modal -->
<div id="modalAdmin" class="overlay hidden">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:760px">
    <h3>üë• Administrar Usuarios</h3>
    <div id="adminList" style="margin-top:10px;max-height:420px;overflow:auto"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn muted" onclick="cerrarModal('modalAdmin')">Cerrar</button>
    </div>
    <div id="adminMsg" style="margin-top:8px"></div>
  </div>
</div>

<!-- hidden input for camera -->
<input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none">

<script>
/* ========= Full integrated optimized app (structure-corrected) ========= */

/* -------- DatabaseManager -------- */
class DatabaseManager {
  constructor(){ this.dbKey='UTNL_DATABASE_v3'; this.backupKey='UTNL_BACKUP_v3'; this.version='3.0'; }
  init(){
    try {
      const db = this.load();
      if(!db || db.version !== this.version) { if(!db) this.createDatabase(); else { db.version = this.version; this.save(db); } }
      this.verifyIntegrity();
    } catch(e){ this.createDatabase(); }
  }
  createDatabase(){
    const newDB = { version:this.version, createdAt:new Date().toISOString(), lastModified:new Date().toISOString(),
      usuarios: {}, metadata:{ totalUsuarios:0, totalRegistros:0 }, lastImported:{} };
    newDB.usuarios.admin = { nombre:'Administrador', password:'admin', datos:[], contadorUb:{estanteria:1,piso:1,seccion:1,posicion:1}, createdAt:new Date().toISOString() };
    this.save(newDB);
  }
  load(){ try{ const s=localStorage.getItem(this.dbKey); return s?JSON.parse(s):null }catch(e){ return null } }
  save(db){ try{ db.lastModified = new Date().toISOString(); localStorage.setItem(this.dbKey, JSON.stringify(db)); localStorage.setItem(this.backupKey, JSON.stringify({data:db,timestamp:new Date().toISOString()})); return true; }catch(e){ console.error(e); return false; } }
  verifyIntegrity(){ const db=this.load()||{}; if(!db.usuarios) db.usuarios = {}; if(!db.metadata) db.metadata = { totalUsuarios:Object.keys(db.usuarios).length, totalRegistros:0 }; let total=0; Object.values(db.usuarios).forEach(u => total += (u.datos?.length || 0)); db.metadata.totalRegistros = total; this.save(db); }
  addUser(userId, data){ const db=this.load(); db.usuarios[userId] = {...data, createdAt:new Date().toISOString()}; db.metadata.totalUsuarios = Object.keys(db.usuarios).length; return this.save(db); }
  getUser(userId){ const db=this.load(); return db?.usuarios?.[userId] || null; }
  getAllUsers(){ const db=this.load(); return db?.usuarios || {}; }
  updateUser(userId, patch){ const db=this.load(); if(!db.usuarios[userId]) return false; db.usuarios[userId] = {...db.usuarios[userId], ...patch, lastModified:new Date().toISOString()}; this.save(db); return true; }
  deleteUser(userId){ const db=this.load(); if(db.usuarios[userId]){ delete db.usuarios[userId]; db.metadata.totalUsuarios = Object.keys(db.usuarios).length; this.save(db); return true; } return false; }
  setLastImported(info){ const db=this.load()||{}; db.lastImported = info; this.save(db); }
  getLastImported(){ return (this.load()||{}).lastImported || null; }
}
const DB = new DatabaseManager();

/* -------- Global state -------- */
let usuarioActual = null;
let datos = [];
let contadorUb = { estanteria:1,piso:1,seccion:1,posicion:1 };

/* -------- Virtualization params -------- */
const ROW_HEIGHT = 68;
const BUFFER_ROWS = 8;
const viewport = document.getElementById('viewport');
const inner = document.getElementById('inner');

/* -------- File/watch state -------- */
let excelFileHandle = null;
let watchInterval = null;
const WATCH_INTERVAL_MS = 10000;
let importAbort = { aborted:false };

/* -------- Save debounce -------- */
let saveTimer = null;
function saveDBDebounced(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> {
    if(!usuarioActual) return;
    const user = DB.getUser(usuarioActual);
    if(user) DB.updateUser(usuarioActual, { ...user, datos, contadorUb });
  }, 600);
}

/* -------- Utils: dates -------- */
function pad(n){ return String(n).padStart(2,'0'); }
function excelSerialToDate(serial){ if(serial instanceof Date) return serial; const n=Number(serial); if(isNaN(n)) return null; const ms=(n-25569)*86400*1000; const d=new Date(ms); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function formatDDMMYYYYAny(value){
  if(!value) return '';
  if(value instanceof Date) return pad(value.getDate())+'/'+pad(value.getMonth()+1)+'/'+value.getFullYear();
  if(!isNaN(Number(value))){
    const maybe = excelSerialToDate(Number(value));
    if(maybe) return pad(maybe.getDate())+'/'+pad(maybe.getMonth()+1)+'/'+maybe.getFullYear();
  }
  const dt = new Date(String(value));
  if(!isNaN(dt)) return pad(dt.getDate())+'/'+pad(dt.getMonth()+1)+'/'+dt.getFullYear();
  return String(value);
}

/* -------- UI helpers -------- */
function mostrarToast(msg, t=2000){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(), t); }
function mostrarInfo(){ alert('Este sistema sincroniza localmente con Excel y permite fotos por registro (guardadas localmente). Usa Chrome/Edge/Safari m√≥vil para mejor experiencia.'); }

/* -------- Init app -------- */
window.addEventListener('load', ()=> {
  DB.init();
  ensureAdmin();
  // hide small loader shortly after ready
  setTimeout(()=> {
    const sl = document.getElementById('smallLoader');
    if(sl) sl.style.display = 'none';
  }, 700);
});

/* -------- Auth / Users -------- */
function ensureAdmin(){ const admin = DB.getUser('admin'); if(!admin) DB.addUser('admin', { nombre:'Administrador', password:'admin', datos:[], contadorUb:{estanteria:1,piso:1,seccion:1,posicion:1} }); }

function mostrarRegistroModal(){ document.getElementById('modalRegistro').classList.remove('hidden'); document.getElementById('regError').textContent=''; }
function cerrarRegistroModal(){ document.getElementById('modalRegistro').classList.add('hidden'); }
function registrarUsuarioModal(){
  const nombre = document.getElementById('regNombre').value.trim();
  const usuario = document.getElementById('regUsuario').value.trim();
  const pass = document.getElementById('regPassword').value;
  const pass2 = document.getElementById('regPasswordConfirm').value;
  const err = document.getElementById('regError'); err.textContent='';
  if(!nombre||!usuario||!pass){ err.textContent='Completa todos los campos'; return; }
  if(pass.length<4){ err.textContent='La contrase√±a debe tener al menos 4 caracteres'; return; }
  if(pass !== pass2){ err.textContent='Las contrase√±as no coinciden'; return; }
  if(DB.getUser(usuario)){ err.textContent='Usuario ya existe'; return; }
  DB.addUser(usuario, { nombre, password:pass, datos:[], contadorUb:{estanteria:1,piso:1,seccion:1,posicion:1} });
  cerrarRegistroModal(); mostrarToast('Usuario registrado ‚úÖ');
}

function iniciarSesion(){
  const u = document.getElementById('loginUsuario').value.trim();
  const p = document.getElementById('loginPassword').value;
  const err = document.getElementById('loginError'); err.textContent='';
  if(!u||!p){ err.textContent='Completa usuario y contrase√±a'; return; }
  const user = DB.getUser(u);
  if(!user){ err.textContent='Usuario no encontrado'; return; }
  if(user.password !== p){ err.textContent='Contrase√±a incorrecta'; return; }
  usuarioActual = u;
  datos = user.datos || [];
  contadorUb = user.contadorUb || {estanteria:1,piso:1,seccion:1,posicion:1};
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  document.getElementById('currentUserName').textContent = `${user.nombre || usuarioActual}`;
  if(usuarioActual === 'admin') document.getElementById('btnAdminPanel').classList.remove('hidden'); else document.getElementById('btnAdminPanel').classList.add('hidden');
  recomputeInnerHeight();
  renderVisibleRows();
  document.getElementById('totalCount').textContent = datos.length;
  mostrarToast('Sesi√≥n iniciada ‚úÖ');
}

function cerrarSesion(){
  persistUserData();
  usuarioActual = null; datos = [];
  document.getElementById('main').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
  document.getElementById('loginUsuario').value=''; document.getElementById('loginPassword').value='';
}

/* cambiar clave */
function abrirCambiarClave(){ document.getElementById('modalCambiar').classList.remove('hidden'); document.getElementById('changePassMsg').textContent=''; }
function cerrarCambiarClave(){ document.getElementById('modalCambiar').classList.add('hidden'); }
function cambiarClave(){
  const cur = document.getElementById('curPass').value;
  const neu = document.getElementById('newPass').value;
  const conf = document.getElementById('confirmNewPass').value;
  const msg = document.getElementById('changePassMsg'); msg.textContent=''; msg.style.color='#d63333';
  if(!usuarioActual){ msg.textContent='No hay sesi√≥n activa'; return; }
  const user = DB.getUser(usuarioActual);
  if(user.password !== cur){ msg.textContent='Contrase√±a actual incorrecta'; return; }
  if(neu.length<4){ msg.textContent='La nueva contrase√±a debe tener al menos 4 caracteres'; return; }
  if(neu !== conf){ msg.textContent='Las contrase√±as no coinciden'; return; }
  DB.updateUser(usuarioActual, { ...user, password:neu });
  msg.style.color='#0a9b5b'; msg.textContent='Contrase√±a actualizada ‚úÖ';
  setTimeout(()=> cerrarCambiarClave(), 1200);
}

function eliminarMiPerfil(){
  if(!usuarioActual){ alert('No has iniciado sesi√≥n'); return; }
  if(!confirm('¬øEliminar tu perfil? Esta acci√≥n es irreversible.')) return;
  const pass = prompt('Ingresa tu contrase√±a para confirmar:');
  const user = DB.getUser(usuarioActual);
  if(!user || user.password !== pass){ alert('Contrase√±a incorrecta'); return; }
  DB.deleteUser(usuarioActual);
  mostrarToast('Perfil eliminado ‚úÖ');
  cerrarSesion();
}

/* Admin panel */
function abrirModalAdmin(){
  if(usuarioActual !== 'admin'){ mostrarToast('Acceso denegado'); return; }
  const list = document.getElementById('adminList'); list.innerHTML = '';
  const users = DB.getAllUsers();
  Object.entries(users).forEach(([username, udata])=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='8px 6px'; el.style.borderBottom='1px solid #eef5fb';
    const left = document.createElement('div'); left.innerHTML = `<strong>${udata.nombre}</strong><div style="color:#556b78;font-size:.9rem">${username} ¬∑ Reg: ${udata.createdAt? new Date(udata.createdAt).toLocaleDateString(): 'N/A'}</div>`;
    const actions = document.createElement('div');
    const btnReset = document.createElement('button'); btnReset.className='btn muted'; btnReset.textContent='Restablecer clave'; btnReset.onclick = ()=> { DB.updateUser(username, {...udata, password:'1234'}); mostrarToast('Clave restablecida'); };
    const btnDel = document.createElement('button'); btnDel.className='btn danger'; btnDel.style.marginLeft='8px'; btnDel.textContent='Eliminar'; btnDel.onclick = ()=> { if(username==='admin'){ alert('No puedes eliminar admin'); return; } if(confirm('Eliminar usuario?')){ DB.deleteUser(username); abrirModalAdmin(); mostrarToast('Usuario eliminado'); } };
    actions.appendChild(btnReset); if(username!=='admin') actions.appendChild(btnDel);
    el.appendChild(left); el.appendChild(actions); list.appendChild(el);
  });
  document.getElementById('modalAdmin').classList.remove('hidden');
}

/* -------- Data helpers (persist) -------- */
function persistUserData(){ if(!usuarioActual) return; DB.updateUser(usuarioActual, { ...DB.getUser(usuarioActual), datos, contadorUb }); }
function getUsuarioDatos(){ return datos || []; }

/* -------- Generar ubicaci√≥n -------- */
function generarUbicacion(){
  if(!contadorUb) contadorUb = {estanteria:1,piso:1,seccion:1,posicion:1};
  contadorUb.posicion++;
  if(contadorUb.posicion>10){ contadorUb.posicion=1; contadorUb.seccion++; if(contadorUb.seccion>5){ contadorUb.seccion=1; contadorUb.piso++; if(contadorUb.piso>5){ contadorUb.piso=1; contadorUb.estanteria++; } } }
  saveDBDebounced();
  return `${contadorUb.estanteria}.${contadorUb.piso}.${contadorUb.seccion}.${contadorUb.posicion}`;
}

/* -------- Ingresar registro -------- */
function ingresarDim(){
  if(!usuarioActual){ alert('Inicia sesi√≥n'); return; }
  const item = document.getElementById('item').value.trim();
  const dim = document.getElementById('numeroDim').value.trim();
  const acta = document.getElementById('acta').value.trim();
  const fecha = document.getElementById('fechaSeleccionadaInput').value;
  const desc = document.getElementById('descripcion').value.trim();
  const cant = Number(document.getElementById('cantidad').value || 0);
  if(!item || !dim || !desc || !cant || !fecha){ alert('Completa Item, DIM, Descripci√≥n, Cantidad y Fecha'); return; }
  const ubic = generarUbicacion();
  const rec = { item, dim, acta, fechaRaw: fecha, descripcion: desc, cantidad: cant, ubicacion: ubic, fechaIngresoRaw: new Date().toISOString(), seleccionado:false, photo: '' };
  datos.push(rec);
  persistUserData();
  recomputeInnerHeight();
  renderVisibleRows();
  document.getElementById('totalCount').textContent = datos.length;
  limpiarInputs();
  mostrarToast('Registro ingresado ‚úÖ');
  intentarEscribirExcelVigilado();
}
function limpiarInputs(){ ['item','numeroDim','acta','fechaSeleccionadaInput','descripcion','cantidad'].forEach(id=> document.getElementById(id).value = (id==='cantidad') ? '0' : ''); }

/* -------- Virtualized rendering (responsive) -------- */
function recomputeInnerHeight(){ inner.style.height = (datos.length * ROW_HEIGHT) + 'px'; document.getElementById('totalCount').textContent = datos.length; }
function onScrollViewport(){ requestAnimationFrame(renderVisibleRows); }
function renderVisibleRows(){
  const scrollTop = viewport.scrollTop;
  const viewportHeight = viewport.clientHeight;
  const totalRows = datos.length;
  const start = Math.max(0, Math.floor(scrollTop/ROW_HEIGHT) - BUFFER_ROWS);
  const end = Math.min(totalRows, Math.ceil((scrollTop + viewportHeight)/ROW_HEIGHT) + BUFFER_ROWS);
  inner.innerHTML = '';
  for(let i=start;i<end;i++){
    const d = datos[i];
    const row = document.createElement('div'); row.className='row'; row.style.top = (i*ROW_HEIGHT)+'px';
    row.innerHTML = `
      <div class="col-checkbox"><input type="checkbox" data-idx="${i}" ${d.seleccionado ? 'checked' : ''}></div>
      <div class="col-item">${escapeHtml(d.item)}</div>
      <div class="col-dim">${escapeHtml(d.dim)}</div>
      <div class="col-acta">${escapeHtml(d.acta||'')}</div>
      <div class="col-fecha">${escapeHtml(formatDDMMYYYYAny(d.fechaRaw))}</div>
      <div class="col-desc">${escapeHtml(d.descripcion||'')}</div>
      <div class="col-cantidad">${escapeHtml(d.cantidad||0)}</div>
      <div class="col-ubic">${escapeHtml(d.ubicacion||'')}</div>
      <div class="col-photo">${d.photo ? '<div class="photo-placeholder">Foto</div>' : '<div class="photo-placeholder">No</div>'}</div>
      <div class="col-ingreso">${escapeHtml(formatDDMMYYYYAny(d.fechaIngresoRaw))}</div>
      <div class="col-actions">
        <button class="fab camera ripple" title="Tomar / Reemplazar foto" data-idx="${i}">üì∏</button>
        <button class="fab view ripple" title="Ver foto" data-idx="${i}">üëÅÔ∏è</button>
        <button class="fab edit ripple" title="Editar foto" data-idx="${i}">‚úèÔ∏è</button>
        <button class="fab delete ripple" title="Eliminar foto" data-idx="${i}">üóëÔ∏è</button>
        <button class="btn danger" style="padding:6px 8px;margin-left:6px" data-delete="${i}">Eliminar</button>
      </div>
    `;
    inner.appendChild(row);
  }
  // attach events
  inner.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.onchange = (e)=>{ const idx = Number(e.target.dataset.idx); if(!isNaN(idx)){ datos[idx].seleccionado = e.target.checked; saveDBDebounced(); } };
  });
  inner.querySelectorAll('button[data-idx]').forEach(btn=>{
    const idx = Number(btn.dataset.idx);
    if(btn.title.includes('Tomar')) btn.onclick = ()=> takePhotoFor(idx);
    else if(btn.title.includes('Ver')) btn.onclick = ()=> viewPhotoFor(idx);
    else if(btn.title.includes('Editar')) btn.onclick = ()=> takePhotoFor(idx);
    else if(btn.title.includes('Eliminar foto')) btn.onclick = ()=> deletePhotoFor(idx);
  });
  inner.querySelectorAll('button[data-delete]').forEach(b=>{
    b.onclick = ()=> { const idx = Number(b.getAttribute('data-delete')); if(confirm('Eliminar este registro?')){ datos.splice(idx,1); persistUserData(); recomputeInnerHeight(); renderVisibleRows(); mostrarToast('Registro eliminado'); } };
  });
}

/* escape */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* selection handlers */
document.getElementById('selectAll').addEventListener('change', (e)=> {
  const v = e.target.checked;
  for(let i=0;i<datos.length;i++) datos[i].seleccionado = v;
  saveDBDebounced();
  renderVisibleRows();
});
function mostrarTodos(){ viewport.scrollTop = 0; renderVisibleRows(); }

function eliminarSeleccionados(){
  const count = datos.filter(d=>d.seleccionado).length;
  if(!count){ alert('No hay seleccionados'); return; }
  if(!confirm(`Eliminar ${count} registros?`)) return;
  datos = datos.filter(d=>!d.seleccionado);
  persistUserData(); recomputeInnerHeight(); renderVisibleRows(); mostrarToast('Registros eliminados');
}

/* -------- Photo handling (compress + save) -------- */
const photoInput = document.getElementById('photoInput');

async function takePhotoFor(idx){
  if(typeof idx !== 'number') return;
  photoInput.value = '';
  photoInput.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    try{
      const dataUrl = await fileToCompressedDataUrl(file, 1024);
      datos[idx].photo = dataUrl;
      persistUserData(); renderVisibleRows(); mostrarToast('Foto guardada ‚úÖ');
    }catch(e){ console.error(e); mostrarToast('Error al procesar foto'); }
    photoInput.onchange = null;
  };
  photoInput.click();
}

async function fileToCompressedDataUrl(file, maxSide=1024){
  const imgBitmap = await createImageBitmap(file);
  const scale = Math.min(1, maxSide / Math.max(imgBitmap.width, imgBitmap.height));
  const canvas = document.createElement('canvas');
  canvas.width = Math.round(imgBitmap.width * scale);
  canvas.height = Math.round(imgBitmap.height * scale);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(imgBitmap, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
  try{ imgBitmap.close && imgBitmap.close(); }catch(e){}
  return dataUrl;
}

function viewPhotoFor(idx){
  if(!datos[idx] || !datos[idx].photo){ mostrarToast('No hay foto para este registro'); return; }
  const img = document.getElementById('viewPhotoImg'); img.src = datos[idx].photo;
  document.getElementById('modalViewPhoto').classList.remove('hidden');
}
function cerrarModal(id){ document.getElementById(id).classList.add('hidden'); if(id==='modalViewPhoto') document.getElementById('viewPhotoImg').src=''; }

function deletePhotoFor(idx){
  if(!datos[idx] || !datos[idx].photo){ mostrarToast('No hay foto para eliminar'); return; }
  if(!confirm('Eliminar la foto de este registro?')) return;
  datos[idx].photo = '';
  persistUserData(); renderVisibleRows(); mostrarToast('Foto eliminada ‚úÖ');
}

/* -------- Persist helpers -------- */
function persistUserData(){ if(!usuarioActual) return; DB.updateUser(usuarioActual, { ...DB.getUser(usuarioActual), datos, contadorUb }); }

/* -------- Import Excel (chunked + progress) -------- */
const progressCard = document.getElementById('progressCard');
const progressFill = document.getElementById('progressFill');

function handleImportEvent(e){ const f = e.target.files && e.target.files[0]; if(!f) return; importExcelFile(f); e.target.value=''; }
function cancelImport(){ importAbort.aborted = true; progressCard.classList.add('hidden'); if(progressFill) progressFill.style.width='0%'; importAbort.aborted=false; mostrarToast('Importaci√≥n cancelada'); }

async function importExcelFile(file){
  try{
    progressCard.classList.remove('hidden');
    if(progressFill) progressFill.style.width='0%';
    importAbort.aborted = false;
    const ab = await file.arrayBuffer();
    const workbook = XLSX.read(ab, { type:'array', cellDates:true });
    const ws = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
    if(!json || !json.length){ alert('Archivo vac√≠o o inv√°lido'); progressCard.classList.add('hidden'); return; }
    const CHUNK = 300;
    const total = json.length;
    let i = 0;
    const nuevos = [];
    while(i < total){
      if(importAbort.aborted) return;
      const end = Math.min(i + CHUNK, total);
      for(let j=i;j<end;j++){
        const row = json[j];
        const r = {
          item: String(row['# Item'] || row['Item'] || '') ,
          dim: String(row['N√∫mero DIM'] || row['N√∫meroDim'] || row['DIM'] || ''),
          acta: String(row['Acta'] || row['# Acta'] || ''),
          fechaRaw: normalizeExcelDateCell(row['Fecha']),
          descripcion: String(row['Descripci√≥n'] || row['Descripcion'] || row['Description'] || ''),
          cantidad: Number(row['Cantidad'] || row['Qty'] || 0),
          ubicacion: String(row['Ubicaci√≥n'] || row['Ubicacion'] || '') || generarUbicacion(),
          fechaIngresoRaw: normalizeExcelDateCell(row['Fecha Ingreso']) || new Date().toISOString(),
          seleccionado:false,
          photo:''
        };
        if(r.item && r.dim) nuevos.push(r);
      }
      i = end;
      if(progressFill) progressFill.style.width = Math.round((i/total)*100) + '%';
      // yield to UI
      await new Promise(res => setTimeout(res, 40));
    }
    const replace = confirm(`Se detectaron ${nuevos.length} registros. Reemplazar existentes? (Cancelar = agregar)`);
    if(replace){ datos = nuevos; } else {
      const mapa = new Map(); datos.forEach(d=> mapa.set(`${d.dim}||${d.item}`, d));
      nuevos.forEach(n=>{
        const key = `${n.dim}||${n.item}`;
        if(mapa.has(key)){
          const ex = mapa.get(key);
          ex.descripcion = n.descripcion || ex.descripcion;
          ex.cantidad = n.cantidad || ex.cantidad;
          ex.ubicacion = n.ubicacion || ex.ubicacion;
          if(n.fechaRaw) ex.fechaRaw = n.fechaRaw;
        } else datos.push(n);
      });
    }
    DB.setLastImported({ name:file.name, timestamp:new Date().toISOString(), count: Math.min(nuevos.length,1000) });
    persistUserData(); recomputeInnerHeight(); renderVisibleRows();
    if(progressFill) progressFill.style.width = '100%';
    setTimeout(()=> progressCard.classList.add('hidden'), 400);
    mostrarToast('Importaci√≥n completada ‚úÖ', 2200);
    document.getElementById('totalCount').textContent = datos.length;
  }catch(err){ console.error(err); alert('Error importando Excel'); progressCard.classList.add('hidden'); if(progressFill) progressFill.style.width='0%'; }
}

function normalizeExcelDateCell(cell){
  if(cell === undefined || cell === null || cell === '') return '';
  if(cell instanceof Date) return cell.toISOString().split('T')[0];
  if(!isNaN(Number(cell))){
    const d = excelSerialToDate(Number(cell));
    if(d) return d.toISOString().split('T')[0];
  }
  return String(cell);
}

/* -------- Export / backup -------- */
function exportarExcel(){
  if(!usuarioActual){ alert('Inicia sesi√≥n'); return; }
  try{
    const encabezados = ['# Item','N√∫mero DIM','Acta','Fecha','Descripci√≥n','Cantidad','Ubicaci√≥n','Fecha Ingreso'];
    const filas = (datos||[]).map(d=>({
      '# Item': d.item||'',
      'N√∫mero DIM': d.dim||'',
      'Acta': d.acta||'',
      'Fecha': d.fechaRaw || '',
      'Descripci√≥n': d.descripcion||'',
      'Cantidad': Number(d.cantidad||0),
      'Ubicaci√≥n': d.ubicacion||'',
      'Fecha Ingreso': d.fechaIngresoRaw || ''
    }));
    const ws = XLSX.utils.json_to_sheet(filas, { header:encabezados });
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
    XLSX.writeFile(wb, `UTNL_${usuarioActual}_${new Date().toISOString().split('T')[0]}.xlsx`);
    mostrarToast('Excel exportado ‚úÖ');
  }catch(e){ console.error(e); alert('Error exportando Excel'); }
}

function exportarBackupDB(){
  const dbAll = DB.load();
  if(!dbAll){ alert('No hay base para exportar'); return; }
  const blob = new Blob([JSON.stringify(dbAll, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `UTNL_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); a.remove();
  mostrarToast('Backup exportado ‚úÖ');
}
function importarBackupDB(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const parsed = JSON.parse(evt.target.result);
      if(!parsed || !parsed.usuarios){ alert('JSON inv√°lido'); return; }
      if(!confirm('Se importar√° la base completa desde JSON y reemplazar√° la actual. ¬øContinuar?')) return;
      localStorage.setItem(DB.dbKey, JSON.stringify(parsed));
      DB.init();
      mostrarToast('Backup importado ‚úÖ');
      if(usuarioActual){
        const u = DB.getUser(usuarioActual);
        if(u){ datos = u.datos || []; recomputeInnerHeight(); renderVisibleRows(); }
      }
    }catch(err){ console.error(err); alert('Error leyendo JSON'); } finally { e.target.value=''; }
  };
  reader.readAsText(file);
}

/* -------- File System Access: watch file -------- */
async function requestFileHandle(){
  try{
    const [handle] = await window.showOpenFilePicker({ types:[{ description:'Excel', accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'], 'application/vnd.ms-excel': ['.xls'] } }], multiple:false });
    return handle;
  }catch(e){ console.warn('No file chosen', e); return null; }
}

async function toggleWatch(){
  if(!('showOpenFilePicker' in window)){ alert('Tu navegador no soporta vigilancia autom√°tica. Usa importar manual.'); return; }
  if(excelFileHandle){ stopWatching(); return; }
  const handle = await requestFileHandle(); if(!handle) return;
  excelFileHandle = handle;
  document.getElementById('watchBtn').classList.add('hidden');
  document.getElementById('stopWatchBtn').classList.remove('hidden');
  updateTopPills();
  watchInterval = setInterval(async ()=>{
    try{
      const file = await handle.getFile();
      const lm = file.lastModified || 0;
      if(!window._lastLM) window._lastLM = lm;
      if(lm !== window._lastLM){
        window._lastLM = lm;
        document.getElementById('lastSync').textContent = new Date().toLocaleString();
        await importExcelFile(file);
        mostrarToast('Datos sincronizados desde archivo vigilado üîÑ');
      }
    }catch(e){ console.warn(e); }
  }, WATCH_INTERVAL_MS);
  mostrarToast('Vigilancia iniciada üîé');
}

function stopWatching(){
  if(watchInterval) clearInterval(watchInterval);
  watchInterval = null; excelFileHandle = null;
  document.getElementById('watchBtn').classList.remove('hidden');
  document.getElementById('stopWatchBtn').classList.add('hidden');
  updateTopPills();
  mostrarToast('Vigilancia detenida ‚èπÔ∏è');
}

function updateTopPills(){ document.getElementById('filePill').textContent = excelFileHandle ? `Archivo vigilado: (seleccionado)` : 'Archivo vigilado: ninguno'; document.getElementById('syncPill').textContent = excelFileHandle ? 'Sincronizaci√≥n: activa' : 'Sincronizaci√≥n: inactiva'; }

/* -------- Writing back to handle (attempt) -------- */
let writeDebounceTimer = null;
async function intentarEscribirExcelVigilado(){
  if(!excelFileHandle) return;
  if(writeDebounceTimer) clearTimeout(writeDebounceTimer);
  writeDebounceTimer = setTimeout(async ()=>{
    try{
      const opts = { mode:'readwrite' };
      const curr = await excelFileHandle.queryPermission(opts);
      if(curr !== 'granted'){
        const req = await excelFileHandle.requestPermission(opts);
        if(req !== 'granted'){ console.warn('No write permission'); return; }
      }
      await writeExcelToHandle();
      mostrarToast('Archivo vigilado actualizado ‚úÖ');
    }catch(e){ console.warn('No se pudo escribir al archivo vigilado', e); }
  }, 900);
}

async function writeExcelToHandle(){
  if(!excelFileHandle) return;
  try{
    const encabezados = ['# Item','N√∫mero DIM','Acta','Fecha','Descripci√≥n','Cantidad','Ubicaci√≥n','Fecha Ingreso'];
    const filas = (datos||[]).map(d=>({
      '# Item': d.item||'',
      'N√∫mero DIM': d.dim||'',
      'Acta': d.acta||'',
      'Fecha': d.fechaRaw || '',
      'Descripci√≥n': d.descripcion||'',
      'Cantidad': Number(d.cantidad||0),
      'Ubicaci√≥n': d.ubicacion||'',
      'Fecha Ingreso': d.fechaIngresoRaw || ''
    }));
    const ws = XLSX.utils.json_to_sheet(filas, { header:encabezados });
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws,
'Inventario');
    const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const writable = await excelFileHandle.createWritable();
    await writable.write(wbout);
    await writable.close();
  }catch(e){ console.error('writeExcelToHandle error', e); throw e; }
}

/* Misc */
window.addEventListener('beforeunload', (e)=> { if(usuarioActual && datos && datos.length){ persistUserData(); } });
document.getElementById('modalViewPhoto').addEventListener('click', (ev)=> { if(ev.target.id==='modalViewPhoto') cerrarModal('modalViewPhoto'); });

/* expose some functions for debugging */
window.ingresarDim = ingresarDim;
window.takePhotoFor = takePhotoFor;
window.viewPhotoFor = viewPhotoFor;
window.deletePhotoFor = deletePhotoFor;
window.exportarExcel = exportarExcel;
window.exportarBackupDB = exportarBackupDB;
window.toggleWatch = toggleWatch;
window.stopWatching = stopWatching;

/* small helpers used above */
function guardarDatosUsuario(){ persistUserData(); mostrarToast('Guardado ‚úÖ'); }
/* === GUARDADO COMPLETO Y PERSISTENTE (CORREGIDO) === */

async function ejecutarGuardadoCompleto() {
  if (!usuarioActual) return;
  try {
    mostrarBarraGuardado();

    const user = DB.getUser(usuarioActual);
    if (user) {
      user.datos = [...datos];
      user.contadorUb = { ...contadorUb };
      DB.updateUser(usuarioActual, user);
      console.log("üíæ Guardado permanente en DB:", usuarioActual, user.datos.length);
    }

    if (excelFileHandle) {
      await intentarEscribirExcelVigilado();
    }

    mostrarToast("Guardado autom√°tico realizado ‚úÖ");
  } catch (e) {
    console.error("‚ùå Error en guardado:", e);
    mostrarToast("Error al guardar ‚ö†Ô∏è");
  }
}

// Guardado manual (bot√≥n)
async function guardarTodoManual() {
  const btn = document.getElementById("btnGuardar");
  if (!btn) return;
  const original = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="small-spinner" style="width:20px;height:20px;border-width:3px;border-color:rgba(255,255,255,0.25);border-top-color:white"></span> Guardando‚Ä¶`;

  try {
    await ejecutarGuardadoCompleto();
  } finally {
    setTimeout(() => {
      btn.innerHTML = original;
      btn.disabled = false;
    }, 2000);
  }
}

// Barra animada
function mostrarBarraGuardado() {
  let barra = document.getElementById("barraGuardado");
  if (!barra) {
    barra = document.createElement("div");
    barra.id = "barraGuardado";
    Object.assign(barra.style, {
      position: "fixed",
      top: "0",
      left: "0",
      width: "0%",
      height: "4px",
      background: "linear-gradient(90deg,#00e676,#00c853)",
      zIndex: "999999",
      transition: "width 1.8s ease"
    });
    document.body.appendChild(barra);
  }
  barra.style.width = "0%";
  requestAnimationFrame(() => {
    barra.style.width = "100%";
  });
  setTimeout(() => {
    barra.style.width = "0%";
  }, 2200);
}

// Guardado autom√°tico cada 3 minutos
setInterval(() => {
  if (usuarioActual && datos && datos.length > 0) {
    ejecutarGuardadoCompleto();
  }
}, 180000);

</script>
</body>
</html>